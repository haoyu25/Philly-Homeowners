---
title: "Optimizing Entitlement Assistance Outreach to Homeowners"
author: "Claudia Low, Haoyu Zhu, Rachel Midgett, Wenjun Zhu"
date: "2025 Spring"
output:
  html_document:
    toc: true
    toc_float: true
    theme: flatly
    code_folding: hide
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  cache = TRUE
)

library(tidycensus)
library(tidyverse)
library(dplyr)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) 
library(corrr)    
library(kableExtra)
library(jtools)   
library(ggstance)
library(ggpubr) 
library(broom.mixed)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(corrr)
library(classInt)
library(stargazer)
library(RSocrata)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(stargazer)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(scales)
library(car)
library(data.table)

options(scipen = 999)
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# Inflation adjust
inflationAdjust2017 <- 1.0213
inflationAdjust2018 <- 1.0244

# Color palette
colors <- c("0" = "#e42524", "1" = "#00ADA9")
```

# Introduction

This report provides a detailed workflow of the project on Homestead Tax Exemption entitlement assisstance outreach, for the City of Philadelphia Office of Philly Stat 360 and Office of Information Technology. The aim of the project is design an algorithm-driven outreach campaign that can cost effectively identify homeowners who are likely to be eligible for the [Homestead Tax Exemption](https://www.phila.gov/services/payments-assistance-taxes/taxes/property-and-real-estate-taxes/get-real-estate-tax-relief/get-the-homestead-exemption/) but are not participating in the program. The project aims to allow our clients to understand where these properties are located, potential outreach strategies, and the associated costs and benefits.

These relevant properties who are identified as most likely eligible for the Homestead Exemption but not taking up the program,  are also thought to be more likely to be subject to “tangled titles,” or family-rental arrangements that require an affidavit to waive need for a rental license.

## Background on Property Tax in Philadelphia
Property tax in Philadelphia is 1.3998% of the property value, as assessed by the Office of Property Assessment,for the 2025 taxx year. This is made up of 0.6159% (City of Philadelphia) and 0.7839% (School District)
The taxes are due March 31st yearly.

## Background on Homestead Exemption
The Homestead Exemption reduces the taxable portion of a homeowner's property assessment by up to $100,000, saving up to $1,399 on real estate taxes annually. The bill signed aimed to lessen the financial burden of new property assessments on Philadelphia homeowners, whose property values increased by an average of 31% after the city delayed the annual calculations for three years due to the pandemic.
Eligibility for the Homestead Exemption is as follows:
•	you must own the property and use it as your primary residence
•	no age or income restrictions
•	Not used exclusively for business purposes or as rental units (a percentage is fine)

A homeowner is Ineligible if a homeowner is already enrolled in these alternative real estate tax relief/abatement programs:
•	Longtime Owner Occupants Program (LOOP), an	income-based program for homeowners who experience a substantial increase in their property assessment.
•	10-year residential tax abatement program, although one can only apply for Homestead Exemption after the abatement is over

Programs that can be used in conjunction with the homestead exemption include 
•	Owner-Occupied Real Estate Tax Payment Agreement (OOPA)
•	Senior Citizen Real Estate Tax Freeze
•	Low-Income Real Estate Tax Freeze
•	Real Estate Tax Installment Plan
• Tax Credits for Active-Duty Reserve and National Guard Members

## Tangled Titles

## Significance of Outreach 

# Data
## Dataset Overview
The primary dataset used is the Property and Assessment History publicly available for download on OpenDataPhilly. 
Six relevant datasets are merged with this primary dataset with common identifying keys such as the parcel number in order to include useful predictor variabels in the model predicting for homeowners most likely eligible but not currently enrolled in the Homestead Exemption.

## Exploratory Analysis
### Property and Assessment History
Every observation in the Property and Assessment History dataset is one property in Philadelphia, with a total of 584,049 properties and 79 features. As this dataset is updated daily, the one used for this project is updated as of 31 January 2025. 

#### Creation of dependent variable
There is a column 'homestead_exemption' within this dataset which indicates the taxable portion amount removed from the property assessment of the house. It should be noted that there are 14 properties that had a homestead exemption larger then $100,000, the maximum possible amount, which is suspected to be a clerical error and has been flagged to the PhillyStat360 team. The dependent variable for the model is derived from this feature by creating a binary variable on whether or not the property is currently enrolled in the homestead exemption program, indicated by a non-zero value. There are 246,853 properties with a homestead exemption.
```{r}
properties <- fread("Data/opa_properties_public.csv")
filtered_properties <- properties %>%
  mutate(exemption = ifelse(homestead_exemption == 0, 0, 1))
```

#### Filtering to residential properties
```{r}
filtered_properties <- filtered_properties %>% mutate(is_residential = ifelse(zoning %in% c(
  "RM1", "RM2", "RM3", "RM4",
  "RSA1", "RSA2", "RSA3", "RSA4", "RSA5", "RSA6", 
  "RSD1", "RSD2", "RSD3", 
  "RM1|RSA5", "RSD1|RSD3", "RSA5|RSA5",
  "RTA1", 
  "CMX1", "CMX2", "CMX2.5", "CMX3", "CMX4", "CMX5", "IRMX"), 1, 0))

# Look into exemption status by zoning code
exemptionbyzoning <- filtered_properties %>%
  group_by(zoning, exemption) %>%
  summarise(count = n(), .groups = "drop") %>%
  tidyr::pivot_wider(names_from = exemption, values_from = count, values_fill = list(count = 0)) %>%
  rename(No_Exemption = `0`, Exemption = `1`)

# Look into number of blank / NA zoning codes
num_blank_zoning <- properties %>%
  filter(zoning == "" | is.na(zoning) | str_trim(zoning) == "") %>%
  nrow()

print(num_blank_zoning)

residential_properties <- filtered_properties %>% filter(is_residential == 1)

```

#### Transform to geodata

```{r}
properties_sf <- st_as_sf(residential_properties, wkt = "shape", crs = 2272)
```

```{r}
census_tracts <- st_read("Data/phila_census1.gpkg")
```

```{r}
census_tracts <- st_transform(census_tracts, 2272)
properties_tract <- st_join(properties_sf, census_tracts)

# Create tract summary
tract_summary <- properties_tract %>%
  group_by(GEOID) %>%
  summarise(
    total_properties = n(),
    homestead_count = sum(homestead_exemption > 0, na.rm = TRUE),
    pct_homestead = (homestead_count / total_properties) * 100,
    .groups = "drop"
  ) %>%
  st_drop_geometry()

# Create final enriched dataset
census_tracts_enriched <- census_tracts %>%
  left_join(tract_summary, by = "GEOID")
```


#### General exploration of variables
One major issue faces is the large number of NA values. Even for those features with a low number of NA values indicated in this table, further investigation reveals that there are many empty cells 
```{r}
#Number of NA values
print(residential_properties %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Column", values_to = "NA_Count"), n = 100)

sum(residential_properties$basements == "")
```

#### Predictor Variables 1 & 2: Eligibility Characteristics
The first predictor variable is based off the key eligibility criteria of the Homestead Exemption program -- whether a homeowner resides long-term in the property itself. The closest proxy of this is whether the mailing street ('mailing_street') address is the same as the property street address ('location'), as the mailing address of the owner is often where the owner lives long-term.

The second predictor variable is based off the ineligibility for the homestead exemption if the homeowner is already enrolled in particular existing tax programs such as the LOOP and the residential tax abatement. This is determined if there is an existing tax relief that exempts a portion of the building from tax. If there is a non-zero value for 'exempt-building' and the property is not currently enrolled in the homestead exemption, it is potentially already enrolled in LOOP or in residential tax abatement.

```{r}
residential_properties <- residential_properties %>% mutate(same_address = ifelse(mailing_street == location, 1, 0))
ggplot(residential_properties, aes(x = factor(same_address), fill = factor(exemption))) +
    geom_bar(position = "dodge") +
    scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
    labs(title = "Mailing Address Matches Property Address", x = "Address Match", y = "Count", fill = "Homestead Exemption") +
    theme_minimal(base_size = 14) +
    theme(panel.grid.major = element_line(color = "grey90"),
          panel.grid.minor = element_blank(),
          legend.position = "bottom",
         plot.title = element_text(vjust = 0.5))

residential_properties <- residential_properties %>% mutate(potential_otherprog = ifelse(exempt_building > 0 & exemption == 0, 1, 0))
ggplot(residential_properties %>% filter(!is.na(potential_otherprog)), 
       aes(x = factor(potential_otherprog), fill = factor(exemption))) +
    geom_bar(position = "dodge") +
    scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
    labs(title = "Tax Relief besides Homestead Exemption", x = "Likely Other Exemption Scheme", y = "Count", fill = "Homestead Exemption") +
    theme_minimal(base_size = 14) +
    theme(panel.grid.major = element_line(color = "grey90"),
          panel.grid.minor = element_blank(),
          legend.position = "bottom",
         plot.title = element_text(vjust = 0.5))
```


#### Predictor Variables 3 & 4: Property Characteristics
Depth of the property as well as the total property area were also predictors, although not as useful as the eligibility criteria. 
```{r}
residential_properties <- residential_properties %>% mutate(is_deep = ifelse(depth > 150, 1, 0)) 
ggplot(residential_properties %>% 
         filter(!is.na(is_deep)), 
       aes(x = factor(is_deep), fill = factor(exemption))) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
  labs(title = "Property Depth by Homestead Exemption", 
       x = "Depth > 300", 
       y = "Count", 
       fill = "Exemption") +
  theme_minimal(base_size = 14) +
  theme(panel.grid.major = element_line(color = "grey90"),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(vjust = 0.5))
residential_properties %>%
  count(is_deep, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)  
residential_properties %>%
  count(same_address, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)  


residential_properties <- residential_properties %>% mutate(large_area = ifelse(total_area > 150000, 1, 0))
residential_properties %>%
  count(large_area, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)  


```



=======
#### Predictor Variables 5 & 6: Potentail Commercial Activity

```{r}
business_license<-st_read("Data/business_licenses.geojson")
```

```{r}
rental_license<-business_license%>%
  filter(licensetype=="Rental",
         #rentalcategory=="Residential Dwellings",
         licensestatus %in% c("Active"))%>%
  select(opa_account_num)%>%
  st_drop_geometry()%>%
  distinct() %>% 
  filter(!is.na(opa_account_num)) %>% 
  mutate(rental_license = 1)  
```

```{r}
properties_rental <- properties_sf %>%
  mutate(parcel_number = as.character(parcel_number))%>%
  left_join(rental_license, by = c("parcel_number" = "opa_account_num"))%>%
  mutate(rental_license = replace_na(rental_license, 0))
```

```{r}
ggplot(properties_rental, aes(x = factor(rental_license), fill = factor(exemption))) +
  geom_bar(position = "dodge") +  
  geom_text(stat = "count", aes(label = ..count.., color = factor(exemption)),  
            position = position_dodge(width = 0.9),  
            vjust = -0.5,  
            size = 3) +  
  scale_fill_manual(values = c("0" = "#e42524", "1" = "#00ADA9"),  
                    labels = c("0" = "No Exemption", "1" = "With Exemption")) +  
  scale_color_manual(values = c("0" = "#e42524", "1" = "#00ADA9")) +  
  labs(title = "Rental Licenses Metrics by Homestead Exemption Status",
       x = "Rental Licenses",
       y = "Count",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(legend.position = "none") 
```

```{r}
commercial_license<-business_license%>%
  filter(licensestatus %in% c("Active"))%>%
  filter(licensetype %in% c(
    "Food Caterer",
    "Food Establishment, Retail Perm Location (Large)",
    "Food Establishment, Retail Permanent Location",
    "Food Manufacturer / Wholesaler",
    "Food Preparing and Serving",
    "Food Preparing and Serving (30+ SEATS)",
    "Motor Vehicle Repair / Retail Mobile Dispensing",
    "Pawn Shop",
    "Precious Metal Dealer",
    "Public Garage / Parking Lot",
    "Residential Property Wholesaler",
    "Tire Dealer",
    "Tow Company",
    "Vacant Commercial Property"
  ))%>%
  select(opa_account_num)%>%
  st_drop_geometry()%>%
  distinct() %>% 
  filter(!is.na(opa_account_num)) %>% 
  mutate(commercial_license = 1) 
```

```{r}
properties_commercial <- properties_sf %>%
  mutate(parcel_number = as.character(parcel_number))%>%
  left_join(commercial_license, by = c("parcel_number" = "opa_account_num"))%>%
  mutate(commercial_license = replace_na(commercial_license, 0))
```

```{r}
ggplot(properties_commercial, aes(x = factor(commercial_license), fill = factor(exemption))) +
  geom_bar(position = "dodge") +  
  geom_text(stat = "count", aes(label = ..count.., color = factor(exemption)),  
            position = position_dodge(width = 0.9),  
            vjust = -0.5,  
            size = 3) +  
  scale_fill_manual(values = c("0" = "#e42524", "1" = "#00ADA9"),  
                    labels = c("0" = "No Exemption", "1" = "With Exemption")) +  
  scale_color_manual(values = c("0" = "#e42524", "1" = "#00ADA9")) +  
  labs(title = "Commercial Licenses Metrics by Homestead Exemption Status",
       x = "Commercial Licenses (Exclude Rental)",
       y = "Count",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(legend.position = "none") 
```

#### Predictor Variables 7 & 8: Tax Balance
```{r}
balances <- read.csv("Data/real_estate_tax_balances_census_tract.csv")
```

```{r}
balance_sf <- census_tracts_enriched %>% 
  left_join(balances %>% select(census_tract,balance,num_props), 
            by = c("GEOID" = "census_tract")) 
```

```{r}
ggplot(balance_sf) +
  geom_sf(aes(fill = balance), color = "white", size = 0.1) + 
  scale_fill_gradientn(colors = c("#00ADA9","#e3f9f7","#f4aa9e", "#e42524"),
                       limits = range(balance_sf$balance, na.rm = TRUE),
                       breaks = range(balance_sf$balance, na.rm = TRUE)
                       ) + 
  labs(title = "Total Tax Balance by Census Tract",
       fill = "Price") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 14),
    plot.subtitle = element_text(size = 6),
    axis.title = element_text(size = 6),
    axis.text = element_blank(),
    legend.text = element_text(size = 6),
    legend.position = "bottom",
    legend.direction = "horizontal"
  )
```

```{r}
# Visualize the relationship
ggplot(balance_sf, aes(x = balance, y = pct_homestead)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess") +
  labs(
    title = "Principle vs. Homestead Participation",
    x = "Total Principle ($)",
    y = "Homestead Participation Rate (%)"
  ) +
  theme_minimal()
```

```{r}
#distinct
balance_distinct <- balances %>%
  mutate(census = as.numeric(substr(census_tract, 6, 9)))%>%
  st_drop_geometry()%>%
  group_by(census) %>% 
  summarise(avg_balance=sum(balance,na.rm=TRUE)/sum(num_props, na.rm = TRUE),
            sum_balance=sum(balance,na.rm=TRUE),
            tax_props=sum(num_props,na.rm=TRUE)) %>%
  ungroup()
```

```{r}
properties_number<-properties_sf%>%
  select(census_tract,exemption,parcel_number)%>%
  mutate(prop=1)%>%
  st_drop_geometry()%>%
  group_by(census_tract)%>%
  summarise(total_props=sum(prop))%>%
  ungroup()

properties_sf_number<-properties_sf%>%
  left_join(properties_number,by="census_tract")

```


```{r}
properties_balance <- properties_sf_number %>%
  select(objectid, census_tract,exemption,parcel_number,total_props)%>%
  left_join(balance_distinct, by = c("census_tract" = "census"))%>%
  mutate(avg_balance = replace(avg_balance, is.na(avg_balance), 0),
         sum_balance = replace(sum_balance, is.na(sum_balance), 0),
         tax_props=replace(tax_props,is.na(tax_props),0))%>%
  mutate(tax_rate=tax_props/total_props)
  
```

```{r}
avg_values <- properties_balance %>%
  st_drop_geometry()%>%
  group_by(exemption) %>%
  summarise(
    'Total Tax Balance (In 100,000)' = mean(sum_balance, na.rm = TRUE)/100000,
    #Tax_Props=mean(tax_props,na.rm=TRUE),
    '% of Properties with Tax Balance'=mean(tax_rate,na.rm=TRUE)*100
  ) %>%
  pivot_longer(cols = -exemption, names_to = "variable", values_to = "mean_value")

ggplot(avg_values, aes(x = variable, y = mean_value, fill = as.factor(exemption))) +
  geom_bar(stat = "identity", width = 0.5, position = position_dodge(width = 0.6)) +

  geom_text(aes(label = round(mean_value, 4), color = as.factor(exemption)), 
            position = position_dodge(width = 0.6), 
            vjust = -0.5, size = 5) +

  labs(title = "Mean of Tax Variables by Exemption Status",
       x = "Metrics",
       y = "Mean Value",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ) +
  
  scale_fill_manual(values = c("#e42524", "#00ADA9"), labels = c("No Exemption", "With Exemption")) +
  scale_color_manual(values = c("#e42524", "#00ADA9"), guide = "none") 

```

# Modeling



