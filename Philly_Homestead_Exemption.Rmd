---
title: "Philly_Homestead_Exemption_Final"
author: "Claudia Low, Haoyu Zhu, Rachel Midgett, Wenjun Zhu"
date: "2025-04-15"
output:
  rmdformats::material:
    code_download: true
    toc_float: true
    highlight: zenburn 
    font: "Lato"    
---

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, results='hide', cache = TRUE)

library(tidycensus)
library(tidyverse)
library(dplyr)
library(sf)
library(spdep)
library(caret)
library(ckanr)
library(FNN)
library(grid)
library(gridExtra)
library(ggcorrplot) 
library(corrr)    
library(kableExtra)
library(jtools)   
library(ggstance)
library(ggpubr) 
library(broom.mixed)
library(RColorBrewer)
library(dplyr)
library(ggplot2)
library(RColorBrewer)
library(corrr)
library(classInt)
library(stargazer)
library(RSocrata)
library(kableExtra)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(lubridate)
library(stargazer)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(scales)
library(stringr)
library(car)
library(data.table)
library(leaflet)
library(knitr)
library(kableExtra)

options(scipen = 999)
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")

# Inflation adjust
inflationAdjust2017 <- 1.0213
inflationAdjust2018 <- 1.0244

# Set up theme and options
colors <- c("0" = "#e42524", "1" = "#00ADA9")

map_theme <- theme_minimal() +
  theme(
    axis.text = element_blank(),
    axis.title = element_blank(),
    panel.grid = element_blank()
  )

options(tigris_use_cache = TRUE)
options(scipen = 999)
```

# Introduction

This report provides a detailed workflow of the project on Homestead Tax Exemption entitlement assisstance outreach, for the City of Philadelphia Office of Philly Stat 360 and Office of Information Technology. The aim of the project is design an algorithm-driven outreach campaign that can cost effectively identify homeowners who are likely to be eligible for the [Homestead Tax Exemption](https://www.phila.gov/services/payments-assistance-taxes/taxes/property-and-real-estate-taxes/get-real-estate-tax-relief/get-the-homestead-exemption/) but are not participating in the program. The project aims to allow our clients to understand where these properties are located, potential outreach strategies, and the associated costs and benefits.

These relevant properties who are identified as most likely eligible for the Homestead Exemption but not taking up the program,  are also thought to be more likely to be subject to “tangled titles,” or family-rental arrangements that require an affidavit to waive need for a rental license.

## Background on Property Tax in Philadelphia
Property tax in Philadelphia is 1.3998% of the property value, as assessed by the Office of Property Assessment,for the 2025 taxx year. This is made up of 0.6159% (City of Philadelphia) and 0.7839% (School District)
The taxes are due March 31st yearly.

## Background on Homestead Exemption
The Homestead Exemption reduces the taxable portion of a homeowner's property assessment by up to $100,000, saving up to $1,399 on real estate taxes annually. The bill signed aimed to lessen the financial burden of new property assessments on Philadelphia homeowners, whose property values increased by an average of 31% after the city delayed the annual calculations for three years due to the pandemic.
Eligibility for the Homestead Exemption is as follows:
•	you must own the property and use it as your primary residence
•	no age or income restrictions
•	Not used exclusively for business purposes or as rental units (a percentage is fine)

A homeowner is Ineligible if a homeowner is already enrolled in these alternative real estate tax relief/abatement programs:
•	Longtime Owner Occupants Program (LOOP), an	income-based program for homeowners who experience a substantial increase in their property assessment.
•	10-year residential tax abatement program, although one can only apply for Homestead Exemption after the abatement is over

Programs that can be used in conjunction with the homestead exemption include 
•	Owner-Occupied Real Estate Tax Payment Agreement (OOPA)
•	Senior Citizen Real Estate Tax Freeze
•	Low-Income Real Estate Tax Freeze
•	Real Estate Tax Installment Plan
• Tax Credits for Active-Duty Reserve and National Guard Members

## Tangled Titles
An issue of concern that may result in a long-term resident not being able to claim for homestead exemption is tangled titles, which occur when a long-term resident effectively functions as a homeowner but lacks legal ownership of the property. This often happens when a family member who owned the property passes away, and the necessary legal processes to formalize the ownership transfer were never completed, leaving the resident ineligible for the exemption. However, Philadelphia has a conditional Homestead Exemption of three years for such cases while the legal transfer of ownership is resolved.

## Significance of Outreach 
Currently, no focused or strategic efforts are being carried out by to identify and reach homeowners who is not enrolled in the Homestead Exemption. Through an accurate identification of eligible homeowners, a cost-effective and efficient targeted outreach will be possible, enabling these homeowners to be made aware of and receive support in keeping their home.

# Data
## Dataset Overview
The primary dataset used is the Property and Assessment History publicly available for download on OpenDataPhilly. 
Six relevant datasets are merged with this primary dataset with common identifying keys such as the parcel number in order to include useful predictor variabels in the model predicting for homeowners most likely eligible but not currently enrolled in the Homestead Exemption.

## Exploratory Analysis
### Property and Assessment History
Every observation in the Property and Assessment History dataset is one property in Philadelphia, with a total of 584,049 properties and 79 features. As this dataset is updated daily, the one used for this project is updated as of 31 January 2025. 

#### Creation of dependent variable
There is a column 'homestead_exemption' within this dataset which indicates the taxable portion amount removed from the property assessment of the house. It should be noted that there are 14 properties that had a homestead exemption larger then $100,000, the maximum possible amount, which is suspected to be a clerical error and has been flagged to the PhillyStat360 team. The dependent variable for the model is derived from this feature by creating a binary variable on whether or not the property is currently enrolled in the homestead exemption program, indicated by a non-zero value. There are 246,853 properties with a homestead exemption.

```{r}
properties <- fread("data/opa_properties_public.csv")
filtered_properties_ex <- properties %>%
  mutate(exemption = ifelse(homestead_exemption == 0, 0, 1))
```

#### Filtering to residential properties

```{r}
filtered_properties_resonly <- filtered_properties_ex %>% mutate(is_residential = ifelse(zoning %in% c(
  "RM1", "RM2", "RM3", "RM4",
  "RSA1", "RSA2", "RSA3", "RSA4", "RSA5", "RSA6", 
  "RSD1", "RSD2", "RSD3", 
  "RM1|RSA5", "RSD1|RSD3", "RSA5|RSA5",
  "RTA1", 
  "CMX1", "CMX2", "CMX2.5", "CMX3", "CMX4", "CMX5", "IRMX"), 1, 0))

# Step 1: Identify owners to remove
ownerstoremove <- properties %>%
  group_by(owner_1) %>%
  summarise(property_count = n(), .groups = "drop") %>%
  filter(str_detect(owner_1, " LLC | LLC|REAL ESTATE|ASSOC|HALABUGI INC|INVESTMENT|CHURCH|1229-1247 NORTH 27TH ST|KINGS HIGHWAY|VILLAGE|
  ACQUISITION|PARTNERS|2101 WASHINGTON AVENUE LL|CHAI NUTS LP|REALTY|PROPERTIES|SPECIAL PEOPLE IN NORTHEA|COMPANY|SPECIAL|
  LAND TRUST|TRUST|SIENA PLACE PLANNED COMMU|NORRIS SQUARE NEIGHBORHOO|201-59 NORTH EIGHTH|PREPARATOR|INVESTORS|
  POINT BREEZE|WPRE III L P|NATIONAL|ARCH V-TEMPLE 16TH STREET|NORTH FOURTH STREET|BANKERS TRUST|COMMONS AT POINT BREEZE|
  VETERAN|PRESERVATION|CONDOMINIUM|199 HUNTING PARK|APARTMENT|HOLDINGS| L P|COURT|SCHOOL|SERVICES|HABITAT FOR HUMANITY|COMMITTEE|BAPTIST|
  COLLEGE|ACQUISITION|DELEO|AMTRAK|RENTALS|PARTICIPATION|SPRING ARTS|SEPTA|WASHINGTON SQUARE|FAIRMOUNT PARK|PARKING|
  ARCH VI - TEMPLE|THE LOFTS|FUND |WHARTON COURT|GROUP|PENTECOST|RAD DIVERSIFIED REIT INC|COMMONS|LIMITED|PENNA |FIRST|CONTRACTOR|POINT BREEZE|BOOTSTRAP|RITTENHOUSE|
  HABITAT FOR HUMANITY|DELAWARE RIVER|ENTERPRISES|COMMUNITY|FOUNDATION|BELL TELEPHONE CO|CENTER|PARTNERS|DEVELOPMENT|
  VET AFFAIRS|FEDERAL|WORKFORCE|PENNDOT|INVESTORS|GEORGE WOODWARD INC|HARRISON INC|JDJ FUND|AFFORDABLE|INTERSTATE| INC |BIO LUCKY STAR INC|LEANNA INC|ELEBAH INC|BENGEMINI CONSULTANTS INC|BUILDERS|KOREAN COMMUNITY DEVELOPM|DEVELOPERS|
  PORTFOLIO|RESIDENTIAL|PHILLY|PROJECT|MANAGEMENT|UMOJA INC|ASSN INC|DELAWARE VALLEY|ARCH VI - TEMPLE N GRATZ|SUPPLY|LOFTS|STREET|OFFICE| LP|CITY|VENTURES|
  UNITED STATES OF AMERICA|PHILA|NON PROFIT|ASSO|HOUSE|NEIGHBORHOOD|PATH INC|UNIV|HOUSING|PROPERTY|COMMONWEALTH|CONRAIL|COMMERCE|
  VENTURES|UNITED|CORRIDOR|SQUARE|CIVIC|ARMY|SALVATION|PENNSYLVANIA|ADMINISTRATOR|TOWNHOMES|CBM|RENTAL|AMERICA INC|ST FRANCIS INN|HOMEOWNERSHIP|
  INSTITUTE|RESOURCES|CONSTRUCTION|L P|TRANSPORTATION|CSX|DREXEL|PASSYUNK|COLLEGE|WISTERCOR INC|SIENA PLACE PUD|EQUITY| CAPITAL|EXPORT|STRAWBERRY MANSION|7-ELEVEN|KEEP PLUGGING THREE INC|OUTSOURCE 2000 INC|CHAI 18 INC|Y E R A INC |WORLD|ADMIN|U S OF AMERICA|AUTHORITY|
  SEPTA|APTS| LTD|CORP")) %>%
  pull(owner_1)  # Extract the list of owners to remove

# Step 2: Filter out properties owned by these owners
filtered_properties <- filtered_properties_resonly %>%
  filter(!owner_1 %in% ownerstoremove)

# Step 3: Check the result
print(filtered_properties)

# Look into exemption status by zoning code
exemptionbyzoning <- filtered_properties %>%
  group_by(zoning, exemption) %>%
  summarise(count = n(), .groups = "drop") %>%
  tidyr::pivot_wider(names_from = exemption, values_from = count, values_fill = list(count = 0)) %>%
  rename(No_Exemption = `0`, Exemption = `1`)

# Look into number of blank / NA zoning codes
num_blank_zoning <- properties %>%
  filter(zoning == "" | is.na(zoning) | str_trim(zoning) == "") %>%
  nrow()

print(num_blank_zoning)

residential_properties <- filtered_properties %>% filter(is_residential == 1)

```

```{r}
# Count the number of properties by owner_1
owner_property_count <- filtered_properties %>%
  group_by(owner_1) %>%
  summarise(property_count = n(), .groups = "drop") %>%
  arrange(desc(property_count))

# View the result
print(owner_property_count, n = 1000)
```

#### Transform to geodata in both 2272 and 4326 planes

```{r}
properties_sf <- st_as_sf(residential_properties, wkt = "shape", crs = 2272)

residential_properties <- properties_sf %>%
  mutate(
    x_2272 = st_coordinates(.)[,1],  # X coordinate in EPSG:2272
    y_2272 = st_coordinates(.)[,2]   # Y coordinate in EPSG:2272
  ) %>%
  st_transform(crs = 4326) %>%
  mutate(
    lon_4326 = st_coordinates(.)[,1],  # Longitude in EPSG:4326
    lat_4326 = st_coordinates(.)[,2]   # Latitude in EPSG:4326
  ) %>%
  st_drop_geometry()
```

# Neighborhoods
```{r}
neighborhoods <- st_read("data/philadelphia-neighborhoods.geojson")
neighborhoods <- st_make_valid(neighborhoods)  
neighborhoods <- neighborhoods %>% st_transform(philly_neighborhoods, crs = 4326)

properties_sf_again <- st_as_sf(residential_properties, coords = c("lon_4326", "lat_4326"), crs = 4326)

properties_with_neighborhood <- st_join(properties_sf_again, neighborhoods, left = TRUE)

properties_with_neighborhood <- properties_with_neighborhood %>%
  mutate(
    lon_4326 = st_coordinates(.)[, 1],  # Extract longitude
    lat_4326 = st_coordinates(.)[, 2]   # Extract latitude
  )

# Keep only relevant columns
residential_properties <- properties_with_neighborhood %>%
  select(-LISTNAME, -MAPNAME, everything(), neighborhood = NAME) %>%
  st_drop_geometry()
```

#### Homestead Rate by Census Tract
```{r}
census_tracts <- st_read("Data/phila_census1.gpkg")
```

```{r}
census_tracts <- st_transform(census_tracts, 2272) %>% 
  mutate(owner_occ_rate = (owner_hh / occupied_units)* 100)

properties_tract <- st_join(properties_sf, census_tracts)

# Create tract summary
tract_summary <- properties_tract %>%
  group_by(GEOID) %>%
  summarise(
    total_properties = n(),
    homestead_count = sum(homestead_exemption > 0, na.rm = TRUE),
    pct_homestead = (homestead_count / total_properties) * 100,
    .groups = "drop"
  ) %>%
  st_drop_geometry()

# Create final enriched dataset
census_tracts_enriched <- census_tracts %>%
  left_join(tract_summary, by = "GEOID")

census_tracts_enriched <- census_tracts_enriched %>%
  mutate(
    owner_occ_rate = (census_tracts_enriched$owner_hh / census_tracts_enriched$occupied_units) * 100
  )
```


#### General exploration of variables
One major issue faces is the large number of NA values. Even for those features with a low number of NA values indicated in this table, further investigation reveals that there are many empty cells. 
```{r}
#Number of NA values
print(residential_properties %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Column", values_to = "NA_Count"), n = 100)
```

```{r}
# Transform data to WGS84 (required for leaflet)
census_tracts_wgs84 <- st_transform(census_tracts_enriched, 4326)

# Create interactive map
leaflet(census_tracts_wgs84) %>%
  addTiles() %>%  # Add OpenStreetMap base map
  addPolygons(
    fillColor = ~colorNumeric(
      palette = "viridis",
      domain = c(0, 100)
    )(pct_homestead),
    fillOpacity = 0.7,
    weight = 1,
    color = "white",
    popup = ~paste(
      "Census Tract:", GEOID, "<br>",
      "Homestead %:", round(pct_homestead, 1), "<br>",
      "Population Density:", round(pop_density, 0), "<br>",
      "Total Properties:", total_properties, "<br>",
      "Median Income:", scales::dollar(median_income)
    )
  ) %>%
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", domain = c(0, 100)),
    values = ~pct_homestead,
    title = "% Homestead Exemption",
    opacity = 0.7
  )
```

```{r}
census_tracts_filtered <- census_tracts_enriched %>%
  filter(pop_density > 0 & total_properties >= 30)  # 30 properties minimum

census_tracts_invalid <- census_tracts_enriched %>%
  filter(pop_density == 0 | total_properties < 30)  # Include low property counts in "invalid"


# Transform both to WGS84
census_tracts_invalid_wgs84 <- st_transform(census_tracts_invalid, 4326)
census_tracts_filtered_wgs84 <- st_transform(census_tracts_filtered, 4326)

# Create map with both layers
leaflet() %>%
  addTiles() %>%
  # Add invalid tracts first (in gray)
  addPolygons(data = census_tracts_invalid_wgs84,
    fillColor = "gray",
    fillOpacity = 0.5,
    weight = 1,
    color = "white",
    popup = "No data available"
  ) %>%
  # Add valid tracts with your original styling
  addPolygons(data = census_tracts_filtered_wgs84,
    fillColor = ~colorNumeric(
      palette = "viridis",
      domain = c(0, 85)
    )(pct_homestead),
    fillOpacity = 0.7,
    weight = 1,
    color = "white",
    popup = ~paste(
    "Census Tract:", GEOID, "<br>",
    "Homestead %:", round(pct_homestead, 1), "%<br>",
    "Total Properties:", total_properties,
    ifelse(total_properties < 100, 
           "<br><i style='color:red'>Note: Low property count may affect reliability</i>", 
           "")
  )

  )%>%
  addLegend(
    position = "bottomright",
    pal = colorNumeric("viridis", domain = c(0, 85)),
    values = census_tracts_filtered_wgs84$pct_homestead,
    title = "% Homestead Exemption",
    opacity = 0.7,
    labFormat = labelFormat(suffix = "%")
  ) %>%
  # Add legend for gray areas
  addLegend(
    position = "bottomright",
    colors = "gray",
    labels = "No Data Available",
    opacity = 0.5
  )
```


```{r}
# Create histogram of homestead exemption distribution
census_hist <- ggplot(census_tracts_enriched %>% 
       filter(pop_density > 0), # Filter out zero population tracts
       aes(x = pct_homestead)) +
  geom_histogram(
    binwidth = 5,
    fill = "#008d8a",
    color = "white"
  ) +
  labs(
    title = "Distribution of Homestead Exemption Rates Across Philadelphia Census Tracts",
    subtitle = "Excluding Zero Population Density Tracts",
    x = "Percentage of Properties with Homestead Exemption",
    y = "Number of Census Tracts"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 14),
    legend.text = element_text(size = 14)
  ) +
  scale_x_continuous(breaks = seq(0, 100, by = 10))

census_hist
```
The distribution shows a roughly normal shape with most tracts clustered between 30-50%
There's a notable drop-off below 30% in the number of tracts
The histogram shows relatively few tracts with rates below 20%

Therefore, census tracts with homestead exemption rates below 30% could be considered to have low enrollment and might warrant targeted outreach or investigation into barriers to participation, assuming they are primarily residential areas and not institutional/special use tracts.

There's a notable drop-off below 30% in the number of tracts. Therefore, census tracts with homestead exemption rates below 30% could be considered to have low enrollment and might warrant targeted outreach or investigation into barriers to participation, assuming they are primarily residential areas.

```{r}
homestead_pattern <- ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = cut(pct_homestead, 
              breaks = c(0, 20, 30, 40, 50, 60, 100),
              labels = c("<20%", "20-30%", "30-40%", "40-50%", "50-60%", ">60%")))) +
  scale_fill_viridis_d(
    name = "Homestead\nExemption Rate",
    na.value = "gray80",
    guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    title = "Homestead Exemption Rates Across Philadelphia",
    subtitle = "By Census Tract (Excluding Zero Population Areas)",
    caption = "Gray areas indicate zero population density tracts"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_blank(),
    legend.text = element_text(size = 14)
  )
```


```{r}
homestead_pattern
#ggsave("outputs/homestead-exemption-pattern.png", homestead_pattern, width = 10, height = 6)
```

```{r}
# Basic summary statistics
summary(census_tracts_enriched$pop_density)

# More detailed statistics
census_tracts_enriched %>%
  summarise(
    mean_density = mean(pop_density, na.rm = TRUE),
    median_density = median(pop_density, na.rm = TRUE),
    q1 = quantile(pop_density, 0.25, na.rm = TRUE),
    q3 = quantile(pop_density, 0.75, na.rm = TRUE)
  )

# Visual distribution
ggplot(census_tracts_enriched, aes(x = pop_density)) +
  geom_histogram(binwidth = 1000) +
  theme_minimal() +
  labs(title = "Distribution of Population Density in Philadelphia Census Tracts",
       x = "Population Density (per square mile)",
       y = "Count of Census Tracts")

```


```{r}
ggplot(census_tracts_enriched, aes(x = pop_density)) +
  geom_histogram(binwidth = 1000) +
  theme_minimal() +
  labs(title = "Distribution of Population Density in Philadelphia Census Tracts",
       x = "Population Density (per square mile)",
       y = "Count of Census Tracts")
```


```{r}
homestead_pattern <- ggplot(census_tracts_enriched %>% 
                           mutate(pct_homestead = case_when(
                             pop_density < 2000 | total_properties < 100 ~ NA_real_,
                             TRUE ~ pct_homestead))) +
  geom_sf(aes(fill = cut(pct_homestead, 
              breaks = c(0, 20, 30, 40, 50, 60, 100),
              labels = c("<20%", "20-30%", "30-40%", "40-50%", "50-60%", ">60%")))) +
  scale_fill_viridis_d(
    name = "Homestead\nExemption Rate",
    na.value = "gray80",
    guide = guide_legend(reverse = TRUE)
  ) +
  labs(
    title = "Homestead Exemption Rates Across Philadelphia",
    subtitle = "By Census Tract",
    caption = "Gray tracts indicate population density < 2,000 per sq. mile or fewer than 100 properties"
  ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_blank(),
    legend.text = element_text(size = 14)
  )

```

```{r}
homestead_pattern
```

```{r}
# Distribution of pct_homestead
summary(tract_summary$pct_homestead)

# Map for low rates (under 30%)
ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = ifelse(pop_density > 0 & pct_homestead < 30, 
              pct_homestead, NA))) +
  scale_fill_viridis_c(
    name = "% Homestead\nExemption\n(Under 30%)",
    na.value = "gray80",
    limits = c(0, 30),
    breaks = seq(0, 30, by = 5)
  ) +
  labs(
    title = "Low Homestead Exemption Rates in Philadelphia",
    subtitle = "Census Tracts Below 30% Enrollment",
    caption = "Gray areas: Zero population density or rates ≥ 30%"
  ) +
  map_theme

# Table for low rates
low_enrollment_tracts <- census_tracts_enriched %>%
  filter(pop_density > 0 & pct_homestead < 30) %>%
  dplyr::select(GEOID, pct_homestead, pop_density) %>%
  arrange(pct_homestead)

low_enrollment_tracts %>%
  st_drop_geometry() %>% 
  arrange(pct_homestead) %>%
  kable(
    col.names = c("Census Tract", "% Homestead", "Population Density"),
    digits = 2,
    caption = "Census Tracts with Low Homestead Exemption Rates (<30%)"
  )

# Map for high rates (over 60%)
ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = ifelse(pop_density > 0 & pct_homestead > 60, 
              pct_homestead, NA))) +
  scale_fill_viridis_c(
    name = "% Homestead\nExemption\n(Over 60%)",
    na.value = "gray80",
    limits = c(60, 82),
    breaks = seq(60, 80, by = 5)
  ) +
  labs(
    title = "High Homestead Exemption Rates in Philadelphia",
    subtitle = "Census Tracts Above 60% Enrollment",
    caption = "Gray areas: Zero population density or rates ≤ 60%"
  ) +
  map_theme

# Table for high rates
low_enrollment_tracts <- census_tracts_enriched %>%
  filter(pop_density > 0 & pct_homestead < 30) %>%
  dplyr::select(GEOID, pct_homestead, pop_density) %>%
  arrange(pct_homestead)

low_enrollment_tracts %>%
  st_drop_geometry() %>% 
  arrange(pct_homestead) %>%
  kable(
    col.names = c("Census Tract", "% Homestead", "Population Density"),
    digits = 2,
    caption = "Census Tracts with Low Homestead Exemption Rates (<30%)"
  )

```

```{r}
# Distribution of pct_homestead with new criteria
summary(tract_summary$pct_homestead[tract_summary$pop_density >= 2000 & tract_summary$total_properties >= 100])

# Map for low rates (under 30%)
ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = ifelse(pop_density >= 2000 & total_properties >= 100 & pct_homestead < 30, 
              pct_homestead, NA))) +
  scale_fill_viridis_c(
    name = "% Homestead\nExemption\n(Under 30%)",
    na.value = "gray80",
    limits = c(0, 30),
    breaks = seq(0, 30, by = 5)
  ) +
  labs(
    title = "Low Homestead Exemption Rates in Philadelphia",
    subtitle = "Census Tracts Below 30% Enrollment",
    caption = "Gray areas: Low density (<2000/sq mi), low property count (<100), or rates ≥ 30%"
  ) +
  map_theme

# Map for high rates (over 60%)
ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = ifelse(pop_density >= 2000 & total_properties >= 100 & pct_homestead > 60, 
              pct_homestead, NA))) +
  scale_fill_viridis_c(
    name = "% Homestead\nExemption\n(Over 60%)",
    na.value = "gray80",
    limits = c(60, 82),
    breaks = seq(60, 80, by = 5)
  ) +
  labs(
    title = "High Homestead Exemption Rates in Philadelphia",
    subtitle = "Census Tracts Above 60% Enrollment",
    caption = "Gray areas: Low density (<2000/sq mi), low property count (<100), or rates ≤ 60%"
  ) +
  map_theme

```

```{r}
low_enrollment_tracts <- census_tracts_enriched %>%
  filter(pop_density >= 2000 & 
         total_properties >= 100 & 
         pct_homestead < 30 &
         owner_occ_rate > 40) %>%
  dplyr::select(GEOID, pct_homestead, pop_density, total_properties) %>%
  arrange(pct_homestead)

# For the map visualization
low_enrollment_tracts_map <- ggplot(census_tracts_enriched) +
  geom_sf(aes(fill = case_when(
    pop_density >= 2000 & 
    total_properties >= 100 & 
    pct_homestead < 30 &
    owner_occ_rate > 40 ~ "#f4aa9e",
    TRUE ~ "gray80"
  ))) +
  scale_fill_identity() +
  labs(
    title = "Low Homestead Exemption Tracts",
    subtitle = "Tracts with <30% Homestead Rate & >40% Owner Occupancy",
    caption = "Gray areas do not meet filtering criteria"
  ) +
  map_theme




low_enrollment_tracts_map
#ggsave("outputs/homestead-exemption-low_enrollment_tracts.png", low_enrollment_tracts_map, width = 10, height = 6)
```

```{r}
ggplot(census_tracts_enriched %>% 
       filter(pop_density >= 2000),
       aes(x = owner_occ_rate)) +
  geom_histogram(
    binwidth = 5,
    fill = "#e42524",
    alpha = 0.8,
    color = "white"
  ) +
  labs(
    title = "Distribution of Owner Occupancy Rates Across Philadelphia Census Tracts",
    subtitle = "Excluding Low Density Areas (<2,000 per square mile)",
    x = "Owner Occupancy Rate (%)",
    y = "Number of Census Tracts"
  ) +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12)
  ) +
  scale_x_continuous(breaks = seq(0, 100, by = 10))

```

### Predictor Variables

#### Predictor Variables 1 & 2: Eligibility Characteristics




The first predictor variable is based off the key eligibility criteria of the Homestead Exemption program -- whether a homeowner resides long-term in the property itself. The closest proxy of this is whether the mailing street ('mailing_street') address is the same as the property street address ('location'), as the mailing address of the owner is often where the owner lives long-term.

The second predictor variable is based off the ineligibility for the homestead exemption if the homeowner is already enrolled in particular exisitng tax programs such as the LOOP and the residential tax abatement. This is determined if there is an existing tax relief that exempts a portion of the building from tax. If there is a non-zero value for 'exempt-building' and the property is not currently enrolled in the homestead exemption, it is potentially already enrolled in LOOP or in residential tax abatement.

```{r}
residential_properties <- residential_properties %>% mutate(same_address = ifelse(mailing_street == location, 1, 0))

ggplot(residential_properties, aes(x = same_address, fill = as.factor(exemption))) +
    geom_bar(position = "dodge") +
    scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
    labs(title = "Mailing Address Matches Property Address", x = "Address Match", y = "Count", fill = "Homestead Exemption") +
    theme_minimal(base_size = 14) +
    theme(panel.grid.major = element_line(color = "grey90"),
          panel.grid.minor = element_blank(),
          legend.position = "bottom",
         plot.title = element_text(vjust = 0.5))

```

#### Predictor Variables: whether the owner has 10 or more properties.

```{r}
owner_property_count <- owner_property_count %>%
  mutate(owner_count = ifelse(property_count >= 10, 1, 0))

```

```{r}
#join to dataset
residential_properties <- residential_properties %>%
  left_join(owner_property_count %>%
              dplyr::select(owner_1, owner_count), 
            by = "owner_1") %>%
  mutate(owner_count = ifelse(is.na(owner_count), 0, owner_count))

```


#### Predictor Variables 3 & 4: Property Characteristics
Depth of the property as well as the total property area were also predictors, although not as useful as the eligibility criteria. 
```{r}
residential_properties <- residential_properties %>% mutate(is_deep = ifelse(depth > 150, 1, 0)) 
ggplot(residential_properties %>% 
         filter(!is.na(is_deep)), 
       aes(x = factor(is_deep), fill = factor(exemption))) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
  labs(title = "Property Depth by Homestead Exemption", 
       x = "Depth > 300", 
       y = "Count", 
       fill = "Exemption") +
  theme_minimal(base_size = 14) +
  theme(panel.grid.major = element_line(color = "grey90"),
        panel.grid.minor = element_blank(),
        legend.position = "bottom",
        plot.title = element_text(vjust = 0.5))
residential_properties %>%
  count(is_deep, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)  
residential_properties %>%
  count(same_address, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)  


residential_properties <- residential_properties %>% mutate(large_area = ifelse(total_area > 150000, 1, 0))
residential_properties %>%
  count(large_area, exemption) %>%
  tidyr::spread(key = exemption, value = n, fill = 0)
```


#### Predictor Variables 5 & 6: Potentail Commercial Activity

These two predictor variables are based on the key eligibility criteria of the Homestead Exemption program, that a property must not be used exclusively for business or rental purposes (partial use is allowed). We divided this criterion into two sections: one assessing the potential for exclusive business use and the other for exclusive rental use. A property is considered to have rental potential if it holds an active rental license, and business potential if it has an active business license (excluding rental licenses). Both variables are binary (has/does not have).

```{r}
business_license<-st_read("Data/business_licenses.geojson")
```

##### Rental License
```{r}
rental_license<-business_license%>%
  filter(licensetype=="Rental",
         #rentalcategory=="Residential Dwellings",
         licensestatus %in% c("Active"))%>%
  dplyr::select(opa_account_num)%>%
  st_drop_geometry()%>%
  distinct() %>% 
  filter(!is.na(opa_account_num)) %>% 
  mutate(rental_license = 1)  
```

```{r}
properties_rental <- properties_sf %>%
  mutate(parcel_number = as.character(parcel_number))%>%
  left_join(rental_license, by = c("parcel_number" = "opa_account_num"))%>%
  mutate(rental_license = replace_na(rental_license, 0))
```

```{r}
ggplot(properties_rental, aes(x = factor(rental_license), fill = factor(exemption))) +
  geom_bar(position = "dodge") +  
  geom_text(stat = "count", aes(label = ..count.., color = factor(exemption)),  
            position = position_dodge(width = 0.9),  
            vjust = -0.5,  
            size = 3) +  
  scale_fill_manual(values = c("0" = "#e42524", "1" = "#00ADA9"),  
                    labels = c("0" = "No Exemption", "1" = "With Exemption")) +  
  scale_color_manual(values = c("0" = "#e42524", "1" = "#00ADA9")) +  
  labs(title = "Rental Licenses Metrics by Homestead Exemption Status",
       x = "Rental Licenses",
       y = "Count",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(legend.position = "none") 
```

```{r}
#join to dataset
residential_properties <- residential_properties %>%
  left_join(properties_rental%>%
              st_drop_geometry()%>%
              dplyr::select(objectid,rental_license), 
            by = c("objectid" = "objectid"))
```


#### Business License (Exclude Rental)

```{r}
commercial_license<-business_license%>%
  filter(licensestatus %in% c("Active"))%>%
  filter(licensetype %in% c(
    "Food Caterer",
    "Food Establishment, Retail Perm Location (Large)",
    "Food Establishment, Retail Permanent Location",
    "Food Manufacturer / Wholesaler",
    "Food Preparing and Serving",
    "Food Preparing and Serving (30+ SEATS)",
    "Motor Vehicle Repair / Retail Mobile Dispensing",
    "Pawn Shop",
    "Precious Metal Dealer",
    "Public Garage / Parking Lot",
    "Residential Property Wholesaler",
    "Tire Dealer",
    "Tow Company",
    "Vacant Commercial Property"
  ))%>%
  dplyr::select(opa_account_num)%>%
  st_drop_geometry()%>%
  distinct() %>% 
  filter(!is.na(opa_account_num)) %>% 
  mutate(commercial_license = 1) 
```

```{r}
properties_commercial <- properties_sf %>%
  mutate(parcel_number = as.character(parcel_number))%>%
  left_join(commercial_license, by = c("parcel_number" = "opa_account_num"))%>%
  mutate(commercial_license = replace_na(commercial_license, 0))
```

```{r}
ggplot(properties_commercial, aes(x = factor(commercial_license), fill = factor(exemption))) +
  geom_bar(position = "dodge") +  
  geom_text(stat = "count", aes(label = ..count.., color = factor(exemption)),  
            position = position_dodge(width = 0.9),  
            vjust = -0.5,  
            size = 3) +  
  scale_fill_manual(values = c("0" = "#e42524", "1" = "#00ADA9"),  
                    labels = c("0" = "No Exemption", "1" = "With Exemption")) +  
  scale_color_manual(values = c("0" = "#e42524", "1" = "#00ADA9")) +  
  labs(title = "Commercial Licenses Metrics by Homestead Exemption Status",
       x = "Commercial Licenses (Exclude Rental)",
       y = "Count",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(legend.position = "none") 
```


```{r}
#join to dataset
residential_properties <- residential_properties %>%
  left_join(properties_commercial%>%
              st_drop_geometry()%>%
              dplyr::select(objectid,commercial_license), 
            by = c("objectid" = "objectid"))
```


#### Predictor Variables 7 & 8: Tax Balance

Tax balance represents the total tax billing in a census tract, including principal, penalties, and interest from previous years. While not explicitly stated in the eligibility criteria for the Homestead Exemption, it may affect homeowners' trust and willingness to apply, influencing the possibility of approval. Additionally, the total tax balance in a census tract can serve as an indicator of broader socioeconomic characteristics, such as income levels, educational attainment, and English proficiency, all of which may impact outreach efforts for the Homestead Exemption program.

In our model, we include two tax balance-related predictor variables: (1) the total tax balance of the census tract where a property is located, and (2) the percentage of properties that owe tax balances of the census tract where a property is located.

```{r}
balances <- read.csv("Data/real_estate_tax_balances_census_tract.csv")
```

```{r}
balance_sf <- census_tracts_enriched %>% 
  left_join(balances %>% dplyr::select(census_tract,balance,num_props), 
            by = c("GEOID" = "census_tract")) %>%
  mutate(
    num_props = ifelse(is.na(total_properties), NA, num_props),
    balance = ifelse(is.na(total_properties), NA, balance)
  )


ggplot(balance_sf) +
  geom_sf(aes(fill = balance), color = "white", size = 0.1) + 
  scale_fill_gradientn(colors = c("#00ADA9","#e3f9f7","#f4aa9e", "#e42524"),
                       limits = range(balance_sf$balance, na.rm = TRUE),
                       breaks = range(balance_sf$balance, na.rm = TRUE)
                       ) + 
  labs(title = "Total Tax Balance by Census Tract",
       fill = "Price") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    plot.title = element_text(size = 14),
    plot.subtitle = element_text(size = 6),
    axis.title = element_text(size = 6),
    axis.text = element_blank(),
    legend.text = element_text(size = 6),
    legend.position = "bottom",
    legend.direction = "horizontal"
  )
```

```{r}
# Visualize the relationship
ggplot(balance_sf, aes(x = balance, y = pct_homestead)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess") +
  labs(
    title = "Tax Balance vs. Homestead Participation",
    x = "Total Principle ($)",
    y = "Homestead Participation Rate (%)"
  ) +
  theme_minimal()
```

```{r}
#distinct
balance_distinct <- balances %>%
  mutate(census = as.numeric(substr(census_tract, 6, 9)))%>%
  st_drop_geometry()%>%
  group_by(census) %>% 
  summarise(balance_avg=sum(balance,na.rm=TRUE)/sum(num_props, na.rm = TRUE),
            balance_total=sum(balance,na.rm=TRUE),
            tax_props=sum(num_props,na.rm=TRUE)) %>%
  ungroup()
```

```{r}
properties_number<-properties_sf%>%
  dplyr::select(census_tract,exemption,parcel_number)%>%
  mutate(prop=1)%>%
  st_drop_geometry()%>%
  group_by(census_tract)%>%
  summarise(total_props=sum(prop))%>%
  ungroup()

properties_sf_number<-properties_sf%>%
  left_join(properties_number,by="census_tract")

```


```{r}
properties_balance <- properties_sf_number %>%
  dplyr::select(objectid, census_tract,exemption,parcel_number,total_props)%>%
  left_join(balance_distinct, by = c("census_tract" = "census"))%>%
  mutate(balance_avg = replace(balance_avg, is.na(balance_avg), 0),
         balance_total = replace(balance_total, is.na(balance_total), 0),
         tax_props=replace(tax_props,is.na(tax_props),0))%>%
  mutate(balance_rate=tax_props/total_props)%>%
  filter(!is.na(census_tract)) 
```

```{r}
avg_values <- properties_balance %>%
  st_drop_geometry()%>%
  group_by(exemption) %>%
  summarise(
    'Total Tax Balance (In 100,000)' = mean(balance_total, na.rm = TRUE)/100000,
    #Tax_Props=mean(tax_props,na.rm=TRUE),
    '% of Properties with Tax Balance'=mean(balance_rate,na.rm=TRUE)*100
  ) %>%
  pivot_longer(cols = -exemption, names_to = "variable", values_to = "mean_value")

ggplot(avg_values, aes(x = variable, y = mean_value, fill = as.factor(exemption))) +
  geom_bar(stat = "identity", width = 0.5, position = position_dodge(width = 0.6)) +

  geom_text(aes(label = round(mean_value, 4), color = as.factor(exemption)), 
            position = position_dodge(width = 0.6), 
            vjust = -0.5, size = 5) +

  labs(title = "Mean of Tax Variables by Exemption Status",
       x = "Metrics",
       y = "Mean Value",
       fill = "Exemption Status") +
  theme_minimal() +
  theme(
    plot.title = element_text(size = 18),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 12),
    legend.text = element_text(size = 12),
    legend.position = "bottom",
    legend.direction = "horizontal"
  ) +
  
  scale_fill_manual(values = c("#e42524", "#00ADA9"), labels = c("No Exemption", "With Exemption")) +
  scale_color_manual(values = c("#e42524", "#00ADA9"), guide = "none") 

```

```{r}
#join to dataset
residential_properties <- residential_properties %>%
  left_join(properties_balance%>%
              st_drop_geometry()%>%
              dplyr::select(objectid,balance_total,balance_rate), 
            by = c("objectid" = "objectid"))
```


#### Predictor Variables 9 & 10: Residential Property Metrics

This sector contains these variables: 
- Avg. Market Value and Avg. Taxable Value  Continuous (Numerical)
- Sd. Market Value and Sd. Taxable Value  Continuous (Numerical)

Properties with lower values are more likely to belong to homeowners who qualify for tax relief.
Homestead Exemption helps stabilize values by reducing taxable assessments.

Our key findings include: 
- Exempted properties have lower market values and taxable values compared to non-exempt ones.
- Standard deviation of market value is lower for exempted properties, suggesting more stable valuations.

```{r}
# Load and inspect the assessments dataset
assessments2 <- read.csv("Data/assessments.csv")
```

```{r}
colnames(assessments2)
head(assessments2, 10)

# Merge properties and assessments data by parcel_number
cleaned_properties <- filtered_properties %>%
  dplyr::select(parcel_number, exemption, is_residential, shape)
assessment_combined <- assessments2 %>%
  left_join(cleaned_properties, by = "parcel_number")

head(assessment_combined)
```

```{r}
# Filter Residential Data
# Filter the combined dataset to include only residential properties
residential_assessment_combined <- assessment_combined %>%
  filter(is_residential == 1)
head(residential_assessment_combined)
colnames(residential_assessment_combined)
```

```{r}
# Market Value Growth Rate by Exemption Status (2016-2025)

# Calculate yearly market value and growth rate by exemption status
yearly_market_value <- residential_assessment_combined %>%
  group_by(year, exemption) %>%
  summarise(total_market_value = sum(market_value, na.rm = TRUE), .groups = 'drop')


yearly_market_value <- yearly_market_value %>%
  arrange(exemption, year) %>%
  group_by(exemption) %>%
  mutate(market_value_growth_rate = (total_market_value - lag(total_market_value)) / lag(total_market_value) * 100)

# Filter data for the years 2016-2025
yearly_market_value_filtered <- yearly_market_value %>%
  filter(year >= 2016 & year <= 2025)

# Plot the market value growth rate
ggplot(yearly_market_value_filtered, aes(x = year, y = market_value_growth_rate, color = as.factor(exemption))) +
  geom_line(size = 1.2) +
  geom_point(size = 2) +
  scale_x_continuous(breaks = seq(2016, 2025, by = 1)) + 
  scale_y_continuous(labels = percent_format(scale = 1)) + 
  scale_color_manual(values = c("0" = "#E42524", "1" = "#00ADA9"), labels = c("No Exemption", "With Exemption")) +
  labs(title = "Market Value Growth Rate (2016-2025)", 
       x = "Year", 
       y = "Growth Rate (%)", 
       color = "Exemption Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))

print(yearly_market_value_filtered)
```

```{r}
# Calculate average growth rate by exemption status
growth_comparison <- yearly_market_value_filtered %>%
  group_by(exemption) %>%
  summarise(market_value_growth_rate = mean(market_value_growth_rate, na.rm = TRUE))

print(growth_comparison)

```

Mean values for market_value, taxable_land, taxable_building, exempt_land, and exempt_building.
Growth rate (average annual growth).
Standard deviation (to measure volatility).

```{r}
# Summarize key metrics for each parcel: mean, growth rate, and standard deviation
residential_summary <- residential_assessment_combined %>%
  group_by(parcel_number) %>%
  summarise(
    avg_market_value = mean(market_value, na.rm = TRUE),
    avg_taxable_land = mean(taxable_land, na.rm = TRUE),
    avg_taxable_building = mean(taxable_building, na.rm = TRUE),
    avg_exempt_land = mean(exempt_land, na.rm = TRUE),
    avg_exempt_building = mean(exempt_building, na.rm = TRUE),
    growth_market_value = (last(market_value) - first(market_value)) / first(market_value) * 100,
    sd_market_value = sd(market_value, na.rm = TRUE),
    sd_taxable_land = sd(taxable_land, na.rm = TRUE),
    sd_taxable_building = sd(taxable_building, na.rm = TRUE)
  )
```

```{r}
# Add exemption and residential status to the summary dataset
residential_summary <- residential_summary %>%
  left_join(
    residential_assessment_combined %>%
      dplyr::select(parcel_number, exemption, is_residential, shape) %>%
      distinct(parcel_number, .keep_all = TRUE),  # Keep one row per parcel_number
    by = "parcel_number"
  )

head(residential_summary)
colnames(residential_summary)
```

```{r}
#join to dataset
residential_properties <- residential_properties %>%
  left_join(residential_summary %>%
              dplyr::select(parcel_number,avg_market_value,sd_market_value), 
            by = c("parcel_number" = "parcel_number"))
```

```{r}
# Analysis by Exemption Status
# Summarize metrics by exemption status
residential_summary_analysis <- residential_summary %>%
  group_by(exemption) %>%
  summarise(
    avg_market_value = mean(avg_market_value, na.rm = TRUE),
    avg_taxable_land = mean(avg_taxable_land, na.rm = TRUE),
    avg_taxable_building = mean(avg_taxable_building, na.rm = TRUE),
    avg_exempt_land = mean(avg_exempt_land, na.rm = TRUE),
    avg_exempt_building = mean(avg_exempt_building, na.rm = TRUE),
    sd_market_value = mean(sd_market_value, na.rm = TRUE),
    sd_taxable_land = mean(sd_taxable_land, na.rm = TRUE),
    sd_taxable_building = mean(sd_taxable_building, na.rm = TRUE)
  ) 

# Convert the summary data to long format for visualization
library(tidyr)
summary_residential_long <- residential_summary_analysis %>%
  pivot_longer(
    cols = -exemption, 
    names_to = "metric", 
    values_to = "value"
  )
```

```{r}
# Plot residential property metrics by exemption status
custom_colors <- c("0" = "#E42524",  
                   "1" = "#00ADA9")  

ggplot(summary_residential_long, aes(x = metric, y = value, fill = as.factor(exemption))) +
  geom_bar(stat = "identity", position = "dodge") +
  scale_fill_manual(values = custom_colors, labels = c("No Exemption", "With Exemption")) +
  labs(title = "Residential Property Metrics by Homestead Exemption Status (2015-2025)",
       x = "Metric", 
       y = "Value", 
       fill = "Exemption Status") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

- Exemptions are more common in lower-value, owner-occupied homes, which tend to have less price volatility.
- Higher-value homes may be more influenced by market forces, leading to greater fluctuations.

```{r}
#Plot Only "avg_market_value" and "sd_market_value"
colnames(summary_residential_long)
summary_filtered <- summary_residential_long %>%
  filter(metric %in% c("avg_market_value", "sd_market_value"))

custom_colors <- c("0" = "#E42524",  
                   "1" = "#00ADA9") 

ggplot(summary_filtered, aes(x = metric, y = value, fill = as.factor(exemption), color = as.factor(exemption))) +
  geom_bar(stat = "identity", position = position_dodge(width = 0.7), width = 0.6, alpha = 0.85) + 
  geom_text(aes(label = round(value, 0)), 
            position = position_dodge(width = 0.7), 
            vjust = -0.5, size = 4.5, fontface = "bold") + 
  ylim(0, max(summary_filtered$value) * 1.2) +
  scale_fill_manual(values = custom_colors, labels = c("No Exemption", "With Exemption")) +
  scale_color_manual(values = custom_colors, guide = "none") +  
  labs(title = "Average and Standard Deviation of Market Value (2015-2025)",
       subtitle = "Comparison of Properties With and Without Exemption",
       x = "Metric", 
       y = "Value ($)", 
       fill = "Exemption Status") +
  theme_minimal(base_size = 14) +
  theme(axis.text.x = element_text(angle = 0, vjust = 0.5, hjust = 0.5, face = "bold"),
        axis.title = element_text(face = "bold"),
        legend.position = "top",
        plot.title = element_text(face = "bold", size = 16),
        plot.subtitle = element_text(size = 13, color = "gray40"))

```


#### Predictor Variables 11 & 12 & 13 : Yearly Trends in Residential Data

Predictive Data to Use:
- Taxable Land & Taxable Building Value   Continuous (Numerical)
- Yearly Growth Rate(Taxable Land & Taxable Building)  Continuous (Numerical)
- If there is sudden changes (growth rate above avg.) Binomial (0 = No sudden change, 1 = Sudden change)

Key Findings:
- Exempt land values remain consistently low, while non-exempt land values increase more significantly over time.
- Taxable building values show a large gap between exempt and non-exempt properties, with non-exempt properties rising much more.

Possible Reason:
Exempted properties are less subject to market-driven tax hikes, while non-exempt ones see faster appreciation and tax increases.

```{r}
yearly_residential_data <- assessments2 %>%
  inner_join(cleaned_properties, by = "parcel_number") %>%
  filter(is_residential == 1)  # Keep only residential properties
```


```{r}
# Summarize yearly residential data by exemption status
yearly_residential_summary <- yearly_residential_data %>%
  group_by(year, exemption) %>%
  summarise(
    market_value = mean(market_value, na.rm = TRUE),
    taxable_land = mean(taxable_land, na.rm = TRUE),
    taxable_building = mean(taxable_building, na.rm = TRUE),
    exempt_land = mean(exempt_land, na.rm = TRUE),
    exempt_building = mean(exempt_building, na.rm = TRUE),
    .groups = "drop"
  )

```

```{r}
# Plot yearly changes in residential metrics
# Convert the data to long format for better visualization
yearly_residential_long <- yearly_residential_summary %>%
  pivot_longer(
    cols = c(market_value, taxable_land, taxable_building, exempt_land, exempt_building),
    names_to = "metric",
    values_to = "value"
  )

# Filter data for years 2015 and later
yearly_residential_long_filtered <- yearly_residential_long %>%
  filter(year >= 2015)

# Generate individual plots for each metric
plots <- yearly_residential_long_filtered %>%
  split(.$metric) %>%
  lapply(function(df) {
    ggplot(df, aes(x = year, y = value, color = as.factor(exemption))) +
      geom_line(size = 1.2) +
      geom_point(size = 2) +
      scale_x_continuous(breaks = seq(2015, max(df$year), by = 1)) +
      scale_color_manual(values = custom_colors, labels = c("No Exemption", "With Exemption")) +
      labs(title = paste("Yearly Change in", unique(df$metric)),
           x = "Year", 
           y = "Value", 
           color = "Exemption Status") +
      theme_minimal() +
      theme(axis.text.x = element_text(angle = 45, hjust = 1))
  })


for (p in plots) {
  print(p)
}
```


#### Predictor Variables 11 & 12 & 13: Property Transfer Types and Exemption Correlation

Key Findings:
- Certain deed types (e.g., Deed - Deceased, Satisfaction of Mortgage, Land Bank Deed) have a higher exemption rate.
Possible Reason:
- These transactions indicate long-term ownership, inheritance, or financial restructuring, which may qualify properties for exemption.
Predictive Data to Use:
- Property deed type Categorical (Nominal)

```{r}
transfers2 <- read.csv("Data/RTT_SUMMARY.csv")

```

```{r}
residential_transfers <- residential_properties %>%
  left_join(transfers2, by = c("parcel_number" = "opa_account_num"))
```

```{r}
# Deed Type Analysis
residential_transfers <- residential_transfers %>%
  mutate(document_type = ifelse(is.na(document_type), "Unknown", document_type))

colnames(residential_transfers)
```

```{r}
exemption_by_document_type <- residential_transfers %>%
  group_by(document_type) %>%
  summarise(
    total_count = n(),
    exemption_count = sum(exemption == 1),
    exemption_proportion = exemption_count / total_count * 100
  ) %>%
  arrange(desc(exemption_proportion))

print(exemption_by_document_type)
```

```{r}
## binomial model:DEED - DECEASED, SATISFACTION OF MORTGAGE, MORTGAGE, ASSIGNMENT OF MORTGAGE
document_exemption_model <- glm(exemption ~ document_type, data = residential_transfers, family = binomial)

summary(document_exemption_model)
```

#### Predictor Variables 11 & 12 & 13: Minimal Financial Consideration Transfers

Key Findings:
- A significant proportion (39.7%) of exempt properties involved minimal financial consideration transfers (≤ $10).
Possible Reason:
- These transfers often occur in family transactions, estate planning, or financial hardship cases, aligning with exemption criteria.
Predictive Data to Use:
- Total transaction value Continuous (Numerical)
- if the properties have minimal financial consideration transfers  Binomial (0 = No, 1 = Yes)

```{r}
# Minimal Financial Consideration Analysis

minimal_threshold <- 10 

colnames(residential_transfers)

minimal_financial_transfers <- residential_transfers %>%
  filter(total_consideration <= minimal_threshold)

sum(is.na(residential_transfers$total_consideration))
#442945

minimal_financial_transfers_tocombine <- residential_transfers %>%
  mutate(min_fin_consid = ifelse(total_consideration <= minimal_threshold, 1, 0))

summary(minimal_financial_transfers_tocombine$min_fin_consid)

colnames(minimal_financial_transfers_tocombine)
```

```{r}
exemption_summary <- minimal_financial_transfers %>%
  group_by(exemption) %>%
  summarise(
    count = n(),
    proportion = count / nrow(minimal_financial_transfers) * 100
  )

print(exemption_summary)
```

```{r}
#Recent(2y) Transfer Analysis

# Convert recording_date to Date format
residential_transfers <- residential_transfers %>%
  mutate(recording_date = as.Date(recording_date.x, format="%Y-%m-%d"))

# Get the current year
current_year <- year(Sys.Date())
```

```{r}
# Filter and summarize recent transfers
residential_transfers_2y <- residential_transfers %>%
  filter(!is.na(recording_date)) %>%
  group_by(parcel_number) %>%
  summarise(
    latest_transfer_year = max(year(recording_date), na.rm = TRUE),  # Most recent transfer year
    exemption = first(exemption),  # Retain exemption status
    .groups = "drop"
  ) %>%
  mutate(
    latest_transfer_year = ifelse(is.infinite(latest_transfer_year), NA, latest_transfer_year)  # Handle infinite values
  )

# Mark properties with recent transfers (within 2 years)
residential_transfers_2y <- residential_transfers_2y %>%
  mutate(has_recent_transfer = ifelse(!is.na(latest_transfer_year) & latest_transfer_year >= (current_year - 2), 1, 0))

# View results
print(head(residential_transfers_2y))
colnames(residential_transfers_2y)
```

```{r}
#join to dataset
transfers_new <- read.csv("residential_transfers_cleaned.csv") %>% rename(has_recent_transfer = has_recent_transfer.x)
residential_properties <- residential_properties %>%
  left_join(
    transfers_new %>%
      dplyr::select(parcel_number, has_recent_transfer, latest_document_type),
    by = c("parcel_number" = "parcel_number")
  )%>%
  mutate(has_recent_transfer = ifelse(is.na(has_recent_transfer), 0, has_recent_transfer))%>%
  mutate(latest_document_type = ifelse(is.na(latest_document_type), "none", latest_document_type))
```


```{r}
# Calculate recent transfer rates by exemption status
exemption_transfer_analysis_residential <- residential_transfers_2y %>%
  group_by(exemption) %>%
  summarise(
    avg_recent_transfer = mean(has_recent_transfer, na.rm = TRUE) * 100  # Convert to percentage
  )

# View results
print(exemption_transfer_analysis_residential)
```

On average, 20.07% of properties without a homestead exemption had a transfer in the past two years, compared to 16.17% of those with an exemption. This indicates that properties without exemptions tend to have a slightly higher likelihood of recent transactions.


```{r}
# Create a contingency table for exemption and recent transfers
exemption_transfer_table <- table(residential_transfers_2y$exemption, residential_transfers_2y$has_recent_transfer)

# Perform chi-square test
chi_test_result <- chisq.test(exemption_transfer_table)

# View test results
print(chi_test_result)
```

#### Predictor Variables 14 & 15 & 16: Census Data

##### Median Home Value

```{r}
# Scatterplot of homestead rates vs median home values
ggplot(census_tracts_enriched %>% 
       filter(pop_density > 0), 
       aes(x = median_home_value, y = pct_homestead)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess", se = TRUE) +
  scale_x_continuous(labels = scales::dollar_format()) +
  theme_minimal() +
  labs(
    title = "Homestead Exemption Rates vs. Home Values",
    x = "Median Home Value",
    y = "Percentage with Homestead Exemption"
  )

#use liner model =lm
colnames(census_tracts_enriched)
census_tracts_enriched$GEOID

colnames(residential_properties)
residential_properties$census_tract
```

```{r}
# Create the linear model
homestead_model <- lm(pct_homestead ~ median_home_value, 
                     data = census_tracts_enriched %>% 
                     filter(pop_density > 0))

# View the summary statistics
summary(homestead_model)

# Visualize with linear fit instead of loess
ggplot(census_tracts_enriched %>% 
       filter(pop_density > 0), 
       aes(x = median_home_value, y = pct_homestead)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +  # Changed from loess to lm
  scale_x_continuous(labels = scales::dollar_format()) +
  theme_minimal() +
  labs(
    title = "Linear Relationship: Homestead Exemption Rates vs. Home Values",
    x = "Median Home Value",
    y = "Percentage with Homestead Exemption"
  )

```

The scatterplot shows the relationship between median home values (x-axis) and homestead exemption rates (y-axis) across Philadelphia census tracts. The pattern suggests:

Homestead exemption rates increase with home values up to around $250,000. 

Peak participation occurs in the $200,000-$300,000 range (around 50%).

There's a slight decline in participation for higher-value homes.

The widening gray area at higher home values indicates more uncertainty in the trend, likely due to fewer data points in that range.

Wide variation in participation rates across all home values, shown by the vertical spread of points


```{r}
#join to dataset
# Extract column names for index 81 to 112
selected_columns <- names(properties_tract)[c(1, 81:113)]
# Perform the left join
residential_properties <- residential_properties %>%
  left_join(
    properties_tract %>% dplyr::select(all_of(selected_columns)),
    by = c("objectid" = "objectid")
  )
```


##### Owner Occupancy

```{r}
# Owner Occupancy vs Homestead Rates Analysis
occupancy_analysis <- census_tracts_enriched %>%
  filter(pop_density > 0) %>%
  mutate(
    owner_occ_rate = (owner_hh / occupied_units) * 100,
    pct_homestead_owners = (homestead_count / owner_hh) * 100
  ) %>%
  dplyr::select(GEOID, owner_occ_rate, pct_homestead_owners)

# Visualize the relationship
ggplot(occupancy_analysis, aes(x = owner_occ_rate, y = pct_homestead_owners)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "loess") +
  labs(
    title = "Owner Occupancy Rate vs. Homestead Participation",
    x = "Owner Occupancy Rate (%)",
    y = "Homestead Participation Rate (%)"
  ) +
  theme_minimal()

# ggsave("outputs/homestead-exemption-distribution.png", census_hist, width = 10, height = 6)
```
This scatter plot reveals important patterns in homestead exemption participation across Philadelphia's neighborhoods. By comparing census tract data on owner occupancy rates (from the 2022 5-year ACS) with homestead exemption enrollment, we can identify areas where participation could be improved.

The data shows that while most Philadelphia census tracts have owner occupancy rates between 25-75%, and generally over half of eligible homeowners participate in the program, there are clear opportunities for improvement. Particularly concerning are:

Census tracts with participation rates below 50%

Areas with high owner occupancy but low program participation

Neighborhoods falling well below the expected participation rate (shown by the blue trend line)

Notably, higher rates of owner occupancy don't automatically translate to higher program participation. This suggests that other factors beyond home ownership - such as awareness of the program, ease of enrollment, or demographic characteristics - may play more significant roles in determining participation rates. These insights can help guide targeted outreach efforts to increase program enrollment among eligible homeowners who are currently missing out on this tax benefit.

```{r}
# Create the dataset with the calculated rates
occupancy_analysis <- census_tracts_enriched %>%
  filter(pop_density > 0) %>%
  mutate(
    owner_occ_rate = (owner_hh / occupied_units) * 100,
    pct_homestead_owners = (homestead_count / owner_hh) * 100
  ) %>%
  dplyr::select(GEOID, owner_occ_rate, pct_homestead_owners)

occupancy_analysis <- occupancy_analysis %>%
  filter(!is.na(pct_homestead_owners) & !is.nan(pct_homestead_owners) & !is.infinite(pct_homestead_owners))

# Fit the linear model
occupancy_model <- lm(pct_homestead_owners ~ owner_occ_rate, data = occupancy_analysis)

# View model summary
summary(occupancy_model)

# Visualize with linear fit
ggplot(occupancy_analysis, aes(x = owner_occ_rate, y = pct_homestead_owners)) +
  geom_point(alpha = 0.6) +
  geom_smooth(method = "lm", se = TRUE) +  # Changed from loess to lm
  labs(
    title = "Linear Relationship: Owner Occupancy vs. Homestead Participation",
    x = "Owner Occupancy Rate (%)",
    y = "Homestead Participation Rate (%)"
  ) +
  theme_minimal()

```

##### Zoning Analysis
```{r}
# Data frame of zoning types
zoning_types <- data.frame(
  Type = c(
    "Single Family Detached",
    "Single Family Attached",
    "Two-Family Attached",
    "Multi-Family",
    "Residential Mixed-Use",
    "Commercial Mixed-Use",
    "Industrial Residential Mixed-Use"
  ),
  Codes = c(
    "RSD1, RSD2, RSD3",
    "RSA1, RSA2, RSA3, RSA4, RSA5, RSA6",
    "RTA1",
    "RM1, RM2, RM3, RM4",
    "RMX1, RMX2, RMX3",
    "CMX1, CMX2, CMX2.5, CMX3, CMX4, CMX5",
    "IRMX"
  ),
  Description = c(
    "Detached houses on individual lots",
    "Attached and semi-detached houses on individual lots",
    "Two-family, semi-detached houses on individual lots",
    "Moderate to high-density multi-unit residential buildings",
    "Residential and mixed-use development, including master plan development",
    "Neighborhood to regional-serving mixed-use development",
    "Mix of low-impact industrial, artisan industrial, residential, and neighborhood commercial uses"
  )
)

# Formatted table
kable(zoning_types,
      col.names = c("Residential Type", "Zoning Codes", "Description"),
      caption = "Philadelphia Residential Zoning Classifications")

```


```{r}
properties_filtered <- filtered_properties %>%
  dplyr::select(
    zoning,
    homestead_exemption,
    is_residential,
    census_tract,
    shape
  )

# First create a zoning type classification
filtered_properties <- filtered_properties %>% 
  mutate(
    zoning_type = case_when(
      zoning %in% c("RSD1", "RSD2", "RSD3") ~ "Single Family Detached",
      zoning %in% c("RSA1", "RSA2", "RSA3", "RSA4", "RSA5", "RSA6") ~ "Single Family Attached",
      zoning %in% c("RTA1") ~ "Two-Family Attached",
      zoning %in% c("RM1", "RM2", "RM3", "RM4") ~ "Multi-Family",
      zoning %in% c("RMX1", "RMX2", "RMX3") ~ "Residential Mixed-Use",
      zoning %in% c("CMX1", "CMX2", "CMX2.5", "CMX3", "CMX4", "CMX5") ~ "Commercial Mixed-Use",
      zoning %in% c("IRMX") ~ "Industrial Residential Mixed-Use",
      TRUE ~ "Other"
    ),
    is_residential = ifelse(zoning_type != "Other", 1, 0)
  )


zoning_summary <- filtered_properties %>%
  filter(is_residential == 1) %>%
  group_by(zoning_type) %>%
  summarise(
    total_properties = n(),
    homestead_count = sum(homestead_exemption > 0, na.rm = TRUE),
    pct_homestead = (homestead_count / total_properties) * 100
  ) %>%
  arrange(desc(pct_homestead))


# Homestead rates by zoning type
zoning_summary_chart <- ggplot(zoning_summary, 
       aes(x = reorder(zoning_type, -pct_homestead), 
           y = pct_homestead)) +
  geom_bar(stat = "identity", 
           fill = "#e42524",
           alpha = 0.8) +
  geom_text(aes(label = round(pct_homestead,1)), 
            vjust = -0.5,
            size = 3) +
  theme_minimal() +
  theme(
    axis.text.x = element_text(angle = 45, hjust = 1),
    panel.grid.major.x = element_blank(),
    plot.title = element_text(size = 18, face = "bold"),
    plot.subtitle = element_text(size = 14),
    axis.title = element_text(size = 14),
    axis.text = element_text(size = 14),
    legend.text = element_text(size = 14)
  ) +
  labs(
    title = "Homestead Exemption Rates by Zoning Category in Philadelphia",
    subtitle = "Residential and Mixed-Use Districts Only",
    x = "Zoning Category",
    y = "Percentage with Homestead Exemption",
    caption = "Source: Philadelphia Property Data, 2025"
  ) +
  scale_y_continuous(
    limits = c(0, max(zoning_summary$pct_homestead) * 1.1),
    labels = function(x) paste0(x, "%")
  )



zoning_summary_chart
# ggsave("outputs/homestead-exemption-zoning_summary_chart.png", zoning_summary_chart, width = 10, height = 6)
```

```{r}
permits <- read.csv("permits.csv")
table(permits$permitdescription)
table(permits$permittype)
sum(permits$permitissuedate == "")

library(lubridate)
library(dplyr)


permits_changeofuse <- permits %>% filter(typeofwork == "Change of Use")

permit_types <- c("NEW CONSTRUCTION PERMIT", 
                  "Residential Building Permit", 
                  "Zoning Permit", 
                  "ZONING PERMIT", 
                  "ZONING/USE PERMIT", 
                  "USE PERMIT")

valid_typeofwork <- c("New Construction or Additions", 
                      "New construction, addition, GFA change", 
                      "Addition and/or Alteration", 
                      "Addition and/or Alterations", 
                      "ADD", 
                      "ALTER", 
                      "Alterations")

permits_filtered <- permits %>%
  mutate(issue_date = ymd_hms(permitissuedate)) %>% 
 filter(issue_date >= as.POSIXct("2016-01-01T00:00:00Z", tz = "UTC") & 
         permitdescription %in% permit_types & 
         (
           typeofwork %in% valid_typeofwork |
           (typeofwork == "Change of Use" & str_detect(approvedscopeofwork, "Residential"))
         )) %>%
  mutate(filterresidential = case_when(
    commercialorresidential == "Residential" ~ 1,
    typeofwork == "Change of Use" & str_detect(approvedscopeofwork, "Residential") ~ 1,
    TRUE ~ 0
  )) %>%
  filter(filterresidential == 1)

permits_summary <- permits_filtered %>%
  group_by(address, geocode_x, geocode_y) %>%
  summarize(
    has_permit = as.integer(n() > 0)
  ) %>%
  ungroup()

properties_with_permits <- filtered_properties %>%
  left_join(permits_summary, by = c("location" = "address")) %>%
  mutate(has_permit = coalesce(has_permit, 0))

properties_with_permits$has_permit <- as.factor(properties_with_permits$has_permit)

ggplot(properties_with_permits, aes(x = has_permit, fill = as.factor(exemption))) +
    geom_bar(position = "dodge") +
    scale_fill_manual(values = colors, labels = c("No Exemption", "With Exemption")) +
    labs(title = "Property has Residential Permit Issued in Last 10 Years", x = "New Permit", y = "Count", fill = "Homestead Exemption") +
    theme_minimal(base_size = 14) +
    theme(panel.grid.major = element_line(color = "grey90"),
          panel.grid.minor = element_blank(),
          legend.position = "bottom",
         plot.title = element_text(vjust = 0.5))
```

# Modeling
```{r}
colnames(residential_properties)
# dependent variable:
# predictor variables (filtered to residential only):

#1-4
#same_address
#likely_otherprog
#
#is_deep
#large_area

#5-8
#rental_license
#commercial_license
#balance_total


#9-10
#avg_market_value
#sd_market_value

#11-13
#document_type
#min_fin_consid
#has_recent_transfer

#14-20
#owner_occ_rate
#poverty_rate
#bach_degree_rate
#limited_english_rate
#median_income
#diversity_index
#pct_foreign_born
```

```{r}
properties_model <- residential_properties %>% 
  dplyr::select(objectid, census_tract, geographic_ward, neighborhood, zip_code, 
                x_2272, y_2272, lon_4326, lat_4326, exemption, same_address,
                is_deep, large_area,owner_count, rental_license, commercial_license, 
                balance_rate, avg_market_value, sd_market_value,
                has_recent_transfer, latest_document_type,
                pct_foreign_born, overall_vacancy_rate, poverty_rate, bach_degree_rate,
                young_owner_rate,senior_owner_rate,family_hh_rate, limited_english_rate,
                diversity_index, median_income, owner_occ_rate,
                cost_burden_rate,mortgage_burden_rate,median_home_value)

write.csv(properties_model,"properties_model.csv", row.names = TRUE)
```

```{r}
print(properties_model %>%
  summarise(across(everything(), ~sum(is.na(.)))) %>%
  tidyr::pivot_longer(cols = everything(), names_to = "Column", values_to = "NA_Count"), n = 200)
```

```{r}
numericVars <- as.data.frame(properties_model) %>%
  dplyr::select(exemption,
                same_address, large_area,owner_count,
                rental_license, commercial_license, balance_rate, 
                avg_market_value, sd_market_value, has_recent_transfer, latest_document_type,
                pct_foreign_born, overall_vacancy_rate, poverty_rate, bach_degree_rate, median_income,
                young_owner_rate,senior_owner_rate, owner_occ_rate,
                family_hh_rate,limited_english_rate,diversity_index,
                cost_burden_rate,mortgage_burden_rate,median_home_value
                ) %>%  
  select_if(is.numeric) %>% 
  na.omit() 

correlation_matrix <- cor(numericVars)

numericVars %>% 
  correlate() %>% 
  autoplot() +
  geom_tile(aes(fill = r), color = "#e9e9e9") +
  geom_text(aes(label = round(r,digits=2)), size = 3) +
  scale_fill_gradient2(low =  "#00ADA9", mid = "white", high =  "#e42524",
                       midpoint = 0, limits = c(-1, 1),
                       breaks = seq(-1, 1, by = 0.2)) +
  labs(title = "Correlation across numeric variables")  # Set plot title
```

# Modelling

## Load required packages for modelling
```{r, include=FALSE}
#Package installs -------------------------------------------------------------
load.fun <- function(x) { 
  x <- as.character(x) 
  if(isTRUE(x %in% .packages(all.available=TRUE))) { 
    eval(parse(text=paste("require(", x, ")", sep=""))) 
    print(paste(c(x, " : already installed; requiring"), collapse=''))
  } else { 
    #update.packages()
    print(paste(c(x, " : not installed; installing"), collapse=''))
    eval(parse(text=paste("install.packages('", x, "')", sep=""))) 
    print(paste(c(x, " : installed and requiring"), collapse=''))
    eval(parse(text=paste("require(", x, ")", sep=""))) 
  } 
} 

########### Required Packages ###########
packages = c("bayesplot", "lme4","RcppEigen",
             "tidyverse", "tidyr", "AmesHousing", "broom", "caret", "dials", "doParallel", "e1071", "earth",
             "ggrepel", "glmnet", "ipred", "klaR", "kknn", "pROC", "rpart", "randomForest",
             "sessioninfo", "tidymodels","ranger", "recipes", "workflows", "themis","xgboost",
             "sf", "nngeo", "mapview","data.table","ggplot2","corrr","rsample","parsnip","tidymodels")

for(i in seq_along(packages)){
  packge <- as.character(packages[i])
  load.fun(packge)
}

session_info()
# Color palette
palette2 <- c("#e42524", "#00ADA9")
palette5 <- c('#BF4146', '#E5A186', '#F1C8BB', '#B3CADB','#6683a9')

```

## Feature overview
Relationships between the selected features were first examined.

```{r}
properties_model<-fread("properties_model.csv")
glimpse(properties_model)
```

### Continous Features
```{r}
data_continous <-properties_model %>%
    dplyr::select(exemption, 
                  geographic_ward, 
                  balance_rate,#balance_total,
                  #avg_market_value,sd_market_value,perc_bdg_exempt,
                  pct_foreign_born,overall_vacancy_rate,limited_english_rate,
                  diversity_index,median_income,median_home_value,owner_occ_rate,owner_count
                  ) %>%
    gather(Variable, value, -exemption) %>%
    ggplot() + 
    geom_density(aes(value, color=as.factor(exemption)), fill = "transparent") + 
    facet_wrap(~Variable, scales = "free") +
    scale_color_manual(values = palette2) +
    labs(title = "Feature associations with Exemption",
         subtitle = "(continous features)")+ theme_minimal()+
  theme(legend.position = "bottom") 

print(data_continous) 

```

### Categorical Features
```{r}
data_categorical<-properties_model %>%
    dplyr::select(exemption, 
                  same_address,is_deep,large_area,
                  rental_license,commercial_license
                  ) %>%
  
    gather(Variable, value, -exemption) %>%
    filter(complete.cases(.))%>%
    count(Variable, value, exemption)%>%
      ggplot(., aes(value, n, fill = as.factor(exemption))) +   
        geom_bar(position = "dodge", stat="identity") +
        facet_wrap(~Variable, scales="free")  +
        scale_fill_manual(values = palette2) +
        labs(x="Categories", y="Value",
             title = "Feature associations with Exemption",
             subtitle = "Categorical features") +
  theme_minimal()+
  theme(legend.position = "bottom",
        axis.text.x = element_text(angle = 60, hjust = 1,size=6))+
  scale_x_discrete(labels = function(x) str_trunc(x, 10)) 

print(data_categorical)
```

### Correlation Matrix
```{r}
numericVars <- as.data.frame(properties_model) %>%
  dplyr::select(exemption, 
                
                young_owner_rate,senior_owner_rate,family_hh_rate,
                limited_english_rate, median_home_value, diversity_index,mortgage_burden_rate
                ) %>%  
  select_if(is.numeric) %>% 
  na.omit() 

correlation_matrix <- cor(numericVars)


numericVars %>% 
  correlate() %>% 
  autoplot() +
  geom_tile(aes(fill = r), color = "#e9e9e9") +
  geom_text(aes(label = round(r,digits=2)), size = 3) +
  scale_fill_gradient2(low =  "#00ADA9", mid = "white", high =  "#e42524",
                       midpoint = 0, limits = c(-1, 1),
                       breaks = seq(-1, 1, by = 0.2)) +
  labs(title = "Correlation across numeric variables")  # Set plot title
```

The final variables were selected for the model as below.
```{r}
variables <- c("geographic_ward", "same_address", 
               "is_deep", "owner_count",
         "rental_license", "commercial_license","balance_rate", 
         "avg_market_value", "sd_market_value", "has_recent_transfer", "latest_document_type",
          "overall_vacancy_rate", "poverty_rate",
         "young_owner_rate","senior_owner_rate","family_hh_rate",
         "limited_english_rate", "median_home_value", "diversity_index",
         "mortgage_burden_rate","owner_occ_rate")

```

```{r}
### Set up Dataset
properties_model<- properties_model%>%
  mutate(property_ID = seq(1:n()))%>%
  dplyr::select(all_of(variables), exemption, zip_code)

```

## Split Dataset

The dataset was split into a training and test set, where the training set comprised 75% of the total properties. The split is stratified by zip code, roughly balancing the zip codes across both sets to ensure minimize unequal geographical representation across both the training and test set. The final test set of 25% of the total properties will be left untouched, and used to evaluate the model after tuning and training are complete.

```{r}
### Initial Split for Training and Test
data_split <- initial_split(properties_model, strata = "zip_code", prop = 0.75)
properties_train <- training(data_split)
properties_test  <- testing(data_split)
```

A Leave-One-Group-Out Cross-Validation (LOGOCV) strategy was then implemented within the training dataset, using geographic ward as the grouping variable. Each fold holds out one geographic ward as the validation set while the model is trained on data from all remaining wards. This process iterates across all wards, where each geographic ward serves as a validation fold once. By accounting for potential spatial autocorrelation, this method helps reduce overfitting and prevents data leakage that could arise from training and testing on geographically proximate observations.
```{r}
### Cross Validation
## LOGOCV on Neighborhood with group_vfold_cv()
cv_splits_geo <- group_vfold_cv(properties_train,  
                                group = "geographic_ward")
print(cv_splits_geo)
```

Feature preprocessing is then conducted—categorical variables are one-hot encoded, predictors with zero variance are removed, and numeric predictors are standardized.
```{r}
# Feature Creation
model_rec <- recipe(exemption ~ ., data = properties_train)  %>%
  step_dummy(all_nominal_predictors()) %>%  
  step_zv(all_predictors()) %>%
  step_center(all_numeric_predictors()) %>%
  step_scale(all_numeric_predictors())
```

## Build Model

An XGBoost was then defined with 200 trees, while the number of variables randomly sampled at each split and the minimum number of observation in a terminal node are tuned with with the help of a hyperparameter grid search.

```{r, include=FALSE}
## Model specifications
XGB_plan <- boost_tree() %>%
  set_args(mtry  = tune()) %>%
  set_args(min_n = tune()) %>%
  #set_args(learn_rate = tune())%>%
  #set_args(tree_depth = tune())%>%
  set_args(trees = 200) %>% 
  set_engine("xgboost") %>% 
  set_mode("regression")


# Hyperparameter grid for glmnet (penalization)
xgb_grid <- expand.grid(
  mtry = c(3, 7,10
           ),  
  min_n = c(1, 5, 10
            )
  #, learn_rate = c(0.01, 0.3), 
  #tree_depth = c(3, 5, 7, 10)  
)

# create workflow
xgb_wf <-
  workflow() %>% 
  add_recipe(model_rec) %>% 
  add_model(XGB_plan)


# fit model to workflow and calculate metrics
control <- control_resamples(save_pred = TRUE, verbose = TRUE)
metrics <- metric_set(rmse, rsq, mape, smape)
xgb_tuned <- xgb_wf %>%
  tune::tune_grid(.,
                  resamples = cv_splits_geo,
                  grid      = xgb_grid,
                  control   = control,
                  metrics   = metrics)
```

The grid search is conducted with the best model selected based on having the lowest Root Mean Squared Error.
```{r}
## metrics across grid
collect_metrics(xgb_tuned)

## 'Best' by some metric and margin
show_best(xgb_tuned, metric = "rsq", n = 15)

xgb_best_params    <- select_best(xgb_tuned, metric = "rmse"   )

xgb_best_wf    <- finalize_workflow(xgb_wf, xgb_best_params)

# last_fit() emulates the process where, after determining the best model, the final fit on the entire training set is needed and is then evaluated on the test set.

xgb_val_fit_geo <- xgb_best_wf %>% 
  last_fit(split     = data_split,
           control   = control,
           metrics   = metrics)

```

This chosen model is run on the test set for evaluation.
```{r}
# Pull best hyperparam preds from out-of-fold predictions
xgb_best_OOF_preds <- collect_predictions(xgb_tuned) %>% 
  filter(mtry  == xgb_best_params$mtry[1] & min_n == xgb_best_params$min_n[1])

# collect validation set predictions from last_fit model
xgb_val_pred_geo    <- collect_predictions(xgb_val_fit_geo)
```

```{r}
collect_metrics(xgb_tuned) %>%
  filter(.metric == "rmse") %>%
  ggplot(aes(x = factor(mtry), y = mean, fill = factor(min_n))) +
  geom_bar(stat = "identity", position = "dodge") +
  labs(title = "RMSE Across Different Hyperparameter Combinations",
       x = "mtry",
       y = "Mean RMSE",
       fill = "min_n") +
  theme_minimal()
```

The threshold is set at 0.5, where any predictions with a probability of 0.5 or over are categorized as predicted to be eligible for the exemption. This has 
```{r}
xgb_val_pred_geo$exemption.pred <- as.factor(ifelse(xgb_val_pred_geo$.pred >= 0.5, "1", "0") )
xgb_val_pred_geo$exemption<-as.factor(xgb_val_pred_geo$exemption)
```

A confusion matrix of the model results was then produced. Breaking it down, 205,188 positives are true positives, meaning they are properties with an existing homestead exemption and were accurately predicted to be eligible for the exemption. 34,598 properties were wrongly predicted to not have an exemption although they were already enrolled in one. This false negative rate should be minimized. 152,373 properties were accurately predicted to not have an existing exemption. One can observe there are 77,317 false positives. This is the target group of interest, in which our model predicts that they should have an exemption, meaning they should be eligible for one, yet are not currently enrolled.
```{r}
caret::confusionMatrix(xgb_val_pred_geo$exemption.pred, xgb_val_pred_geo$exemption, 
                       positive = "1")
```

```{r}
library(data.table)
fwrite(xgb_val_pred_geo, "xgb_val_pred_geo.csv")
```

```{r}
library(plotROC)

ggplot(xgb_val_pred_geo, aes(d = as.numeric(exemption), m = .pred)) +
  geom_roc(n.cuts = 50, labels = FALSE, colour = "#BF4146") +
  style_roc(theme = theme_grey) +
  geom_abline(slope = 1, intercept = 0, size = 1, color = '#6683a9') +
  labs(title = "ROC Curve") +
  theme_minimal()
```


The density distribution of the predicted probabilities were then plotted. 
```{r}

ggplot(xgb_val_pred_geo, aes(x = .pred, fill = as.factor(exemption))) + 
  geom_density() +
  facet_grid(exemption ~ .) +
  scale_fill_manual(values = palette2) +
  labs(x = "Probabilities", y = "Density of probabilities",
       title = "Distribution of predicted probabilities by observed outcome",
             subtitle = "No gentrification = 0, Gentrification = 1") +
  theme_minimal() +
  theme(legend.position = "none") 

```

```{r}
properties_model<-fread("properties_model.csv")
xgb_full_pred <- xgb_best_wf %>% 
  fit(data = properties_model) %>%
  predict(new_data = properties_model) %>%
  bind_cols(properties_model)

```

```{r}
xgb_full_pred <- xgb_full_pred %>%
  mutate(exemption.pred = ifelse(.pred >= 0.5, "1", "0"))
```

```{r}
fwrite(xgb_full_pred, "xgb_full_pred.csv")
```


# Target Outreach












# Outreach Strategies and Associated Costs and Benefits
Two main potential outreach strategies are proposed. The costs for each of these strategies were then estimated based on existing cost structure references.

The first potential strategy is a direct mailing campaign, which involves sending flyers out to all properties identified as false positives by the model. The flyer would contain information on what the homestead exemption program is, its eligibility criteria, instructions on how to apply, and relevant contact information, translated across different languages.  

The next potential strategy is a door-knocking campaign. This involves going door-to-door to identified properties and having canvassers knock on the doors, sharing with homeowners who respond about the homestead exemption program. This face-to-face interaction can highly effective in raising awareness about the program, how to apply to it, and directly address any queries or doubts that the homeowner may have about it. From July 2023 to June 2024, the City of Philadelphia conducted a door-knocking campaign under the Overdose Awareness Canvassing and Trusted Community Messenger Program. Door-knocking is proposed to be conducted for high potential areas with clusters of missed homestead exemption opportunities. This optimizes limited resources in travel time and costs between properties for door knocking. This campaign would therefore only target the 13,031 homes identified in the two clusters, Northeast and South Philadelphia, which have 6,669 and 6,362 target outreach homes respectively.

```{r, message=FALSE, warning=FALSE}
costs <- data.frame(
  Category = c(
    "Personnel", "Purchase Services", "Program Supplies", "Indirect Costs", "Total"
  ),
  `Direct Mailing\n(All: 77,317 homes)` = c(
    2806, 726, 29678, 3321, 36532
  ),
  `Door-Knocking\n(High-Potential Clusters: 13,031 homes)` = c(
    29840, 66816, 3798, 10045, 110499
  )
)

costs[ ,2:3] <- lapply(costs[ ,2:3], dollar)

kable(costs, align = "lrr", escape = FALSE, caption = "Program Outreach Costs by Strategy") %>%
  kable_styling(full_width = FALSE, bootstrap_options = c("striped", "hover"))

```

Another potential strategy is to reach out to community organizations to educate organization leaders and staff about the exemption program, who can then spread the word to their members and the immediate local community about it. This may include social service organization or religious organizations, such as the United Communities Houston Center or the City of Life church in South Philadelphia.


The potential benefits of such outreach campaigns are vast. With an assumption that 10% of all homeowners we outreach to then successfully enroll into a homestead exemption, there can be up to $10,815,669 of savings across the homeowners. Majority of the homestead exemptions have been observed to receive the maximum eligible exemption. Comparing this to the total outreach cost for both strategies of $18,4132, the outreach can bring massive public benefit for a relatively small amount. Furthermore, this estimate is does not even include the huge unquantified benefits of increased housing stability for homeowners and their families. This reduces transience and encourages owner occupancy and long term residency, which supports consistent neighborhood networks, fostering more engaged and invested local communities. Owner-occupied homes are also more likely to be well-maintained as there is greater incentive to upkeep the property, which benefits neighborhood aesthetics and property values.

# Comparison to a business-as-usual filtering approach
```{r}
filtered_properties_resonly <- filtered_properties_ex %>% mutate(is_residential = ifelse(zoning %in% c(
  "RM1", "RM2", "RM3", "RM4",
  "RSA1", "RSA2", "RSA3", "RSA4", "RSA5", "RSA6", 
  "RSD1", "RSD2", "RSD3", 
  "RM1|RSA5", "RSD1|RSD3", "RSA5|RSA5",
  "RTA1", 
  "CMX1", "CMX2", "CMX2.5", "CMX3", "CMX4", "CMX5", "IRMX"), 1, 0))

ownerstoremove <- properties %>%
  group_by(owner_1) %>%
  summarise(property_count = n(), .groups = "drop") %>%
  filter(str_detect(owner_1, " LLC | LLC|REAL ESTATE|ASSOC|HALABUGI INC|INVESTMENT|CHURCH|1229-1247 NORTH 27TH ST|KINGS HIGHWAY|VILLAGE|
  ACQUISITION|PARTNERS|2101 WASHINGTON AVENUE LL|CHAI NUTS LP|REALTY|PROPERTIES|SPECIAL PEOPLE IN NORTHEA|COMPANY|SPECIAL|
  LAND TRUST|TRUST|SIENA PLACE PLANNED COMMU|NORRIS SQUARE NEIGHBORHOO|201-59 NORTH EIGHTH|PREPARATOR|INVESTORS|
  POINT BREEZE|WPRE III L P|NATIONAL|ARCH V-TEMPLE 16TH STREET|NORTH FOURTH STREET|BANKERS TRUST|COMMONS AT POINT BREEZE|
  VETERAN|PRESERVATION|CONDOMINIUM|199 HUNTING PARK|APARTMENT|HOLDINGS| L P|COURT|SCHOOL|SERVICES|HABITAT FOR HUMANITY|COMMITTEE|BAPTIST|
  COLLEGE|ACQUISITION|DELEO|AMTRAK|RENTALS|PARTICIPATION|SPRING ARTS|SEPTA|WASHINGTON SQUARE|FAIRMOUNT PARK|PARKING|
  ARCH VI - TEMPLE|THE LOFTS|FUND |WHARTON COURT|GROUP|PENTECOST|RAD DIVERSIFIED REIT INC|COMMONS|LIMITED|PENNA |FIRST|CONTRACTOR|POINT BREEZE|BOOTSTRAP|RITTENHOUSE|
  HABITAT FOR HUMANITY|DELAWARE RIVER|ENTERPRISES|COMMUNITY|FOUNDATION|BELL TELEPHONE CO|CENTER|PARTNERS|DEVELOPMENT|
  VET AFFAIRS|FEDERAL|WORKFORCE|PENNDOT|INVESTORS|GEORGE WOODWARD INC|HARRISON INC|JDJ FUND|AFFORDABLE|INTERSTATE| INC |BIO LUCKY STAR INC|LEANNA INC|ELEBAH INC|BENGEMINI CONSULTANTS INC|BUILDERS|KOREAN COMMUNITY DEVELOPM|DEVELOPERS|
  PORTFOLIO|RESIDENTIAL|PHILLY|PROJECT|MANAGEMENT|UMOJA INC|ASSN INC|DELAWARE VALLEY|ARCH VI - TEMPLE N GRATZ|SUPPLY|LOFTS|STREET|OFFICE| LP|CITY|VENTURES|
  UNITED STATES OF AMERICA|PHILA|NON PROFIT|ASSO|HOUSE|NEIGHBORHOOD|PATH INC|UNIV|HOUSING|PROPERTY|COMMONWEALTH|CONRAIL|COMMERCE|
  VENTURES|UNITED|CORRIDOR|SQUARE|CIVIC|ARMY|SALVATION|PENNSYLVANIA|ADMINISTRATOR|TOWNHOMES|CBM|RENTAL|AMERICA INC|ST FRANCIS INN|HOMEOWNERSHIP|
  INSTITUTE|RESOURCES|CONSTRUCTION|L P|TRANSPORTATION|CSX|DREXEL|PASSYUNK|COLLEGE|WISTERCOR INC|SIENA PLACE PUD|EQUITY| CAPITAL|EXPORT|STRAWBERRY MANSION|7-ELEVEN|KEEP PLUGGING THREE INC|OUTSOURCE 2000 INC|CHAI 18 INC|Y E R A INC |WORLD|ADMIN|U S OF AMERICA|AUTHORITY|
  SEPTA|APTS| LTD|CORP")) %>%
  pull(owner_1)  # Extract the list of owners to remove

# Step 2: Filter out properties owned by these owners
filtered_properties <- filtered_properties_resonly %>%
  filter(!owner_1 %in% ownerstoremove)

residential_properties <- filtered_properties %>% filter(is_residential == 1)
```
It is then explroed how the use of the model compares to an alternative approach of a filtered list of properties. The properties are filtered to residential-only, non-corporation owned properties with the same address as its mailing address. This results in 333,623 properties, which would cost $143,668 to execute solely the direct mailing campaign. Using a machine learning model to identify properties to reach out to substantially narrows down the target number, allowing for huge cost-savings and an effective use of limited resources. The spatial analysis of false positives also allow for more targeted door-knocking to take place.


# Biasness Check of Model