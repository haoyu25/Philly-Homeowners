# Install necessary libraries
```{r}
library(dplyr)
library(ggplot2)
library(tidyverse)
library(caret)
library(knitr) 
library(pscl)
library(plotROC)
library(pROC)
library(scales)
library(tidycensus)
library(tigris)
library(sf)
options(scipen = 999)
root.dir = "https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/DATA/"
source("https://raw.githubusercontent.com/urbanSpatial/Public-Policy-Analytics-Landing/master/functions.r")
```

# Main Property Dataset
```{r}
properties <- read.csv("Data/opa_properties_public.csv")
colnames(properties)
table(properties$homestead_exemption)
length(which(properties$homestead_exemption==0))
length(which(properties$homestead_exemption==100000))
sum(is.na(properties$homestead_exemption))

max(properties$homestead_exemption)
which(properties$homestead_exemption == max(properties$homestead_exemption))
properties[566284, ]

# to send to Maggy White
length(which(properties$homestead_exemption>100000))
propertiesfiltered <- properties %>% filter(homestead_exemption >100000)
write.csv(propertiesfiltered, file = "properties_exceeding_exemption.csv")

ggplot(properties, aes(y = homestead_exemption)) + 
  geom_boxplot()

propertieshomestead <- properties %>% filter(homestead_exemption != 0)
propertieshomestead$exceed <- ifelse(propertieshomestead$homestead_exemption > 100000, "exceed", "within")
table(propertieshomestead$exceed)
mean(propertieshomestead$market_value, na.rm = TRUE)
median(propertieshomestead$market_value, na.rm = TRUE)
mean(propertieshomestead$sale_price, na.rm = TRUE)
median(propertieshomestead$sale_price, na.rm = TRUE)

propertiesNOThomestead <- properties %>% filter(homestead_exemption == 0)
mean(propertiesNOThomestead$market_value, na.rm = TRUE)
median(propertiesNOThomestead$market_value, na.rm = TRUE)
mean(propertiesNOThomestead$sale_price, na.rm = TRUE)
median(propertiesNOThomestead$sale_price, na.rm = TRUE)

mean(propertieshomestead$total_livable_area, na.rm = TRUE)
median(propertieshomestead$total_livable_area, na.rm = TRUE)
mean(propertiesNOThomestead$total_livable_area, na.rm = TRUE)
median(propertiesNOThomestead$total_livable_area, na.rm = TRUE)


ggplot(propertieshomestead, aes(x=market_value)) + 
  geom_histogram(color="black", fill="white", bins = 100)

ggplot(propertiesNOThomestead, aes(x=market_value)) + 
  geom_histogram(color="black", fill="white", bins = 100)

table(propertiesNOThomestead$zoning)

filtered_properties <- properties %>%
  mutate(homestead_group = ifelse(homestead_exemption == 0, "No Exemption", "With Exemption"))

# Create the bar chart
ggplot(filtered_properties, aes(x = zoning, fill = homestead_group)) +
  geom_bar(position = "dodge") +
  scale_fill_manual(values = c("No Exemption" = "red", "With Exemption" = "blue")) +
  labs(
    title = "Comparison of Zoning Categories by Homestead Exemption Status",
    x = "Zoning",
    y = "Count",
    fill = "Homestead Exemption"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))


```


# Commercial Activity Licenses Dataset

Eligibility: Not used exclusively for business purposes or as rental units (a percentage is fine) 

##Potential Variable: F/T exclusively for business purposes (Binary) 

F/T - Does the applicant hold a commercial license?  

Property owner name â€“ commercial licenses owner name -- status 

```{r}
comlicenses <- read.csv("Data/com_act_licenses.csv")
head(comlicenses, 10)
```

```{r}

comlicenses_clean <- comlicenses %>% 
  mutate(across(where(is.character), ~ na_if(.x, "")))%>%
  select(where(~ any(!is.na(.))))%>%
  select(licensenum,licensestatus,legalfirstname,legallastname,legalentityid)

head(comlicenses_clean)

```

```{r}

summary(comlicenses_clean)
sapply(comlicenses_clean, function(x) sum(is.na(x)))

```


```{r}
ggplot(comlicenses_clean, aes(x = licensestatus)) +
  geom_bar(fill = "steelblue", color = "black") +
  labs(title = "License Status Distribution", x = "License Status", y = "Count") +
  theme_minimal()
```

## Integrate by owner name

```{r}
#prepare to integrate with property
comlicenses_licenses<-comlicenses_clean%>%
  filter(licensestatus=="Active")%>%
  mutate(full_name = paste(legallastname, legalfirstname))%>%
  distinct(full_name, .keep_all = TRUE)
```


```{r}

#integrate with property
properties_comlicenses <- properties %>%
  left_join(comlicenses_licenses %>%
              select(full_name, licensestatus), by = c("owner_1" = "full_name")) %>%
  left_join(comlicenses_licenses %>%
              select(full_name, licensestatus), by = c("owner_2" = "full_name"))%>%
  mutate(com_potential = ifelse(licensestatus.x == "Active" | licensestatus.y == "Active", TRUE, FALSE))%>%
  select(-licensestatus.x, -licensestatus.y)%>%
  mutate(com_potential = replace_na(com_potential, FALSE))

```

```{r}
#plot
ggplot(properties_comlicenses, aes(x = com_potential, fill = com_potential)) +
  geom_bar() +
  labs(title = "Potential Commercial Licenses",
       x = "com_potential",
       y = "Count") +
  theme_minimal()

```


# Tax balances

May have some negative effect in application 

```{r}
balances <- read.csv("Data/real_estate_tax_balances_census_tract.csv")
```

```{r}
philly_tracts <- tracts(state = "PA", county = "Philadelphia", year = 2024, class = "sf")%>%
  select(GEOID) 
```
```{r}
balance_sf <- philly_tracts %>% 
  inner_join(balances, by = c("GEOID" = "census_tract")) 
```

```{r}

summary(balance_sf %>% select(num_props, balance, avg_balance))
sapply(balance_sf %>% select(num_props, balance, avg_balance), function(x) sum(is.na(x)))

```

```{r}

ggplot(balance_sf) +
  geom_sf(aes(fill = num_props), color = "black", size = 0.2) +  
  scale_fill_viridis_c(option = "plasma") +  
  labs(title = "Number of Properties by census tract",
       fill = "Num Properties") + 
  theme_minimal()

ggplot(balance_sf) +
  geom_sf(aes(fill = balance), color = "black", size = 0.2) + 
  scale_fill_viridis_c(option = "plasma") + 
  labs(title = "Total Balance by census tract",
       fill = "Balance") + 
  theme_minimal()

ggplot(balance_sf) +
  geom_sf(aes(fill = avg_balance), color = "black", size = 0.2) + 
  scale_fill_viridis_c(option = "plasma") + 
  labs(title = "Average Balance by census tract",
       fill = "Avg Balance") + 
  theme_minimal()

```

```{r}
#integrate with property by census tract
balance_sf <- balance_sf %>%
  mutate(census = as.numeric(substr(GEOID, 6, 9)))
```

```{r}
#distinct
balance_distinct <- balance_sf %>%
  st_drop_geometry()%>%
  group_by(census) %>% 
  summarise(avg_balance = sum(balance, na.rm = TRUE) / sum(num_props, na.rm = TRUE)) %>%
  ungroup()

```

```{r}
properties_balance <- properties %>%
  left_join(balance_distinct, by = c("census_tract" = "census"))
```

```{r}
summary(properties_balance$avg_balance)
```

